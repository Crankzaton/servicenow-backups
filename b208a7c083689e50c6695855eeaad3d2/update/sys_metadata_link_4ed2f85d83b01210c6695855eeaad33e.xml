<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>3e7f4ad0eb933010aa2ab2bc03522872</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Updates platform analytics event aggregation config with new encrypted_username field for sn_cda_tracked_visit_agg. Move sn_cda_tracked_visit_agg user data to new glide_encrypted field.&lt;/description&gt;
        &lt;name&gt;Update paf_evt_agg_cfg&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[var grPAFConfig = new GlideRecord("paf_evt_agg_cfg");
grPAFConfig.addEncodedQuery("sys_id=ed4a46e9e75033008901268b03f6a94e");
grPAFConfig.query();
if (grPAFConfig.next()) {
    var keytoAppend = "encrypted_username";
    var aggKeys = grPAFConfig.getValue("agg_keys");
    var isKeyUpdateReqd = true;
    if (gs.nil(aggKeys))
        aggKeys = keytoAppend;
    else {
        var aggKeysArr = aggKeys.split(',');
        for (var i = 0; i &lt; aggKeysArr.length; ++i) {
            if (aggKeysArr[i] === keytoAppend) {
				isKeyUpdateReqd = false;
				gs.info("PAF update : key already exists");
                break;
            }
        }
        if (isKeyUpdateReqd)
            aggKeys += "," + keytoAppend;
    }
    if (isKeyUpdateReqd)
        grPAFConfig.setValue("agg_keys", aggKeys);
    var isKeyDescUpdateReqd = true;
    var keysDescriptorStr = grPAFConfig.getValue("keys_descriptor");
    var keysDescJSON = [];
    if (!gs.nil(keysDescriptorStr)) {
        keysDescJSON = JSON.parse(keysDescriptorStr);
        var key = "key";
        for (var j = 0; j &lt; keysDescJSON.length; ++j) {
            if (keysDescJSON[j][key] === keytoAppend) {
                isKeyDescUpdateReqd = false;
                gs.info("PAF update : key descriptor already exists");
                break;
            }
        }
    }
    if (isKeyDescUpdateReqd) {
        keysDescJSON.push({
            length: 100,
            internalType: "string",
            key: keytoAppend
        });
        grPAFConfig.setValue("keys_descriptor", JSON.stringify(keysDescJSON));
    }
    if (isKeyUpdateReqd || isKeyDescUpdateReqd) {
        grPAFConfig.update();
        gs.info("PAF update : Updated the PAF config with the new field encrypted_user");
    } else
        gs.info("PAF update : Config update not required");
}
var gr = new GlideRecord("sn_cda_tracked_visit_agg");
gr.addNotNullQuery("user");
gr.addNullQuery("encrypted_username");
gr.query();
var rowCount = 0;
gs.info("Starting sn_cda_tracked_visit_agg update. " + gr.getRowCount() + " records found.");
while(gr.next()) {
	gr.setValue("encrypted_username", gs.base64Encode(gr.getValue("user")));
	gr.update();
	rowCount++;
}
gs.info("Finished sn_cda_tracked_visit_agg update. " + rowCount + " records updated.");]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2021-10-15 18:11:46&lt;/sys_created_on&gt;
        &lt;sys_id&gt;3e7f4ad0eb933010aa2ab2bc03522872&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;2&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Update paf_evt_agg_cfg&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;d1a90625e7121300809a268b03f6a982&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value=""&gt;d1a90625e7121300809a268b03f6a982&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_3e7f4ad0eb933010aa2ab2bc03522872&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-10-18 18:11:46&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:20:28</sys_created_on>
        <sys_id>4ed2f85d83b01210c6695855eeaad33e</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Update paf_evt_agg_cfg</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_4ed2f85d83b01210c6695855eeaad33e</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:20:28</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
