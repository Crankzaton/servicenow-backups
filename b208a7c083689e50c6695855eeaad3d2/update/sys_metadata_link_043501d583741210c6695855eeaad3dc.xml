<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>cdb29f2b53b30110fad4ddeeff7b1229</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;The main purpose of this script is to revert some updates in Tokyo if customizations are made.&lt;/description&gt;
        &lt;name&gt;Update FSM Mobile To Tokyo&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[
/***
 * What :
 * The main purpose of this script is to revert some updates in Tokyo if customizations are made.
 * 
 * How :
 * First it checks the version of the last upgrade,
 * then loop through file combonations, revert them if there is a customization
 * 
 * Who :
 * owner --- Field Service Management
 * 
 */

    // Initialize the Collision Detector to check customizations
    var gcd = GlideCollisionDetector.get();

 function mainProcess(){
    // execute the upgrade script only when the system is upgraded to Tokyo
    if (!isTokyo()){
        msgHandler("upgrade is not to Tokyo.");
        msgHandler("FSM Tokyo upgrade script finished.");
        return;
    }

    if (gs.nil(gcd)) {
        msgHandler("Error in initiating GlideCollisionDetector.");
        msgHandler("FSM Tokyo upgrade script finished.");
        return;
    }

    // handle the  button/ parameter screen/ write back action comboes 
    for(var i = 0; i&lt; write_back_list.length; i++){
        var sys_sg_write_back_action_item_id = write_back_list[i]["old_sys_sg_write_back_action_item"];
        var sys_sg_parameter_screen_id = write_back_list[i]["sys_sg_parameter_screen"];
        var sys_sg_button_id = write_back_list[i]["sys_sg_button"];

        // Check the customization for a combo by the file names
        if(isCustomized("sys_sg_write_back_action_item_" + sys_sg_write_back_action_item_id)
         || isCustomized("sys_sg_button_" + sys_sg_button_id) 
         || isCustomized("sys_sg_parameter_screen_" + sys_sg_parameter_screen_id)){

            // revert the write_back_action_item to the previous one if any customizations are made
            msgHandler("Customization in write back combonation is found.");
            var sys_sg_button_rec = new GlideRecord("sys_sg_button");
            sys_sg_button_rec.get(sys_sg_button_id);
            sys_sg_button_rec.setValue("write_back_action_item", sys_sg_write_back_action_item_id);
            sys_sg_button_rec.update();
        }
    }

    // handle the card templates
    for(var i = 0; i &lt; card_template_list.length; i ++){
        var screen_id = card_template_list[i]["screen_id"];
        var screen_table = card_template_list[i]["table"];
        // get the rec for the for screen screen or master item for the list screen
        var screen_rec = new GlideRecord(screen_table);
        screen_rec.get(screen_id);

        // detect the card was using an item_view or view_config
        var is_item_view = card_template_list[i]["is_item_view"];
        var old_card_id = card_template_list[i]["old_card_id"];

        var old_card;
        if(is_item_view){
            old_card = "sys_sg_item_view_" + old_card_id;
        }else{
            old_card = "sys_sg_view_config_" + old_card_id;
        }

        if(isCustomized(old_card)){
            msgHandler("Customization in card template is found.");
            if(is_item_view){
                // if is_item_view is true, make sure use_view_config is unchecked
                screen_rec.setValue("use_view_config", false);
                screen_rec.setValue("sys_sg_item_view", old_card_id);
            }
            else{
                screen_rec.setValue("use_view_config", true);
                screen_rec.setValue("sys_sg_view_config", old_card_id);
            }
            screen_rec.update();
        }
    }

    // exit after the loops above
    msgHandler("FSM Tokyo upgrade script finished.");
    return;
}

     //  Run a GlideCollisionDetector to check if the file has been customized
    function isCustomized(file_name) {
        if (gcd.containsKey(file_name)) {
            return true;
        }
        return false;
    }

// Check the last upgrade record in table sys_upgrade_history
// Assume the upgrade is to Tokyo if the build contains string 'tokyo'
    function isTokyo(){
        var gr = new GlideRecord('sys_upgrade_history');
        gr.addEncodedQuery('from_version!=n/a');
        gr.orderByDesc('upgrade_finished');
        gr.setLimit('1');
        gr.query();
        if (gr.next()) {
            var version = gr.to_version;
            if(version.indexOf("tokyo") !== -1){
                return true;
            }
        }
        return false;
    }

    // handle messages
    function msgHandler(msg){
        gs.info(msg);
    }


    // In Tokyo, we changed some write back into multi steps.
    // If customers made any changes among buttons/ parameter screen/ write back actions,(as a combo)
    // we should revert the mapping of write back actions to the buttons.
    var write_back_list = [
        {
            "name" : "wot_close_incomplete_multistep",
            "sys_sg_button" : "1f8821630fa12010bc89378dc4767e84",
            "sys_sg_parameter_screen" : "922aa1a30fa12010bc89378dc4767e7a",
            "old_sys_sg_write_back_action_item" : "7ba861630fa12010bc89378dc4767e4b",
        },
        {
            "name" : "wot_close_complete_multistep",
            "sys_sg_button" : "5b282d230fa12010bc89378dc4767e62",
            "sys_sg_parameter_screen" : "29892d630fa12010bc89378dc4767e99",
            "old_sys_sg_write_back_action_item" : "bd58ad230fa12010bc89378dc4767e3d",
        },
        {
            "name" : "edit_incidental_parameter_screen",
            "sys_sg_button" : "73eccd1eb70220107be0e34e9e11a97e",
            "sys_sg_parameter_screen" : "1818d9d2b74220107be0e34e9e11a95f",
            "old_sys_sg_write_back_action_item" : "efa6024bb7360010d518fc54ce11a9c9",
        },
        {
            "name" : "Log Incidentals - MultiStep",
            "sys_sg_button" : "ded92f80b7c22010f49afc54ce11a912",
            "sys_sg_parameter_screen" : "313ad7c8b7822010f49afc54ce11a963",
            "old_sys_sg_write_back_action_item" : "45986380b7c22010f49afc54ce11a942",
        }
    ]
    

    // We updated some card templates 
    // So if customers made changes to the original view config/item view
    // we should revert the card mapping to the old one
    var card_template_list = [
        {
            "table": "sys_sg_form_screen",
            "screen_id": "cf3caf7253b0330097a2ddeeff7b128a",
            "is_item_view" : true,
            "description" : "old Work Order Main on recent Work Order form screen",
            "old_card_id" : "54bca0c5e781230003cd6188d2f6a984"
        },
        {
            "table": "sys_sg_form_screen",
            "screen_id": "104cef7253b0330097a2ddeeff7b1243",
            "is_item_view" : true,
            "description" : "old Work Order Main Card on WO form screen",
            "old_card_id" : "39fb3d05e7c1230003cd6188d2f6a90c"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "ca2ceb7253b0330097a2ddeeff7b126f",           
            "is_item_view" : true,
            "description" : "old Asset Map list card",
            "old_card_id" : "462ceb7253b0330097a2ddeeff7b126d"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "1775d4d5e781230003cd6188d2f6a944",              
            "is_item_view" : true,
            "description" : "My Part Requirement Item View been replaced by a view config",
            "old_card_id" : "00a74a1ae711230074246188d2f6a905"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "9ccc062cb7832010f49afc54ce11a969",    
            "is_item_view" : false,
            "description" : "Similar Work Order Item View Config",
            "old_card_id" : "50fc862cb7832010f49afc54ce11a93d"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "2caf2449e781230003cd6188d2f6a969",    
            "is_item_view" : true,
            "description" : "Work Order Main been replaced by a view config",
            "old_card_id" : "54bca0c5e781230003cd6188d2f6a984"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "19f90968c72340104c1bf9f91dc26081",    
            "is_item_view" : true,
            "description" : "Native Questionnaires Item View - Completed been replaced by a view config",
            "old_card_id" : "762a8968c72340104c1bf9f91dc260a0"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "ba288de4c72340104c1bf9f91dc26017",    
            "is_item_view" : true,
            "description" : "Native Questionnaires Item View - Pending been replaced by a view config",
            "old_card_id" : "e2288de4c72340104c1bf9f91dc26010"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "0b97da040fc32010bc89378dc4767e12",    
            "is_item_view" : false,
            "description" : "Work Order Task Main Card",
            "old_card_id" : "c2988619eba22010742442d7b5522884"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "422ceb7253b0330097a2ddeeff7b1258",    
            "is_item_view" : true,
            "description" : "old My Task Map been replaced by a view config",
            "old_card_id" : "b52ceb7253b0330097a2ddeeff7b1255"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "f22b1786e7c1230003cd6188d2f6a917",    
            "is_item_view" : false,
            "description" : "Incidental List and Detail Item View Config",
            "old_card_id" : "b8646690c79e20104c1bf9f91dc2608a"
        },
        {
            "table": "sys_sg_master_item",
            "screen_id": "17bea887733623008c5127cb1bf6a740",    
            "is_item_view" : true,
            "description" : "old Team Members item view been replaced by a view config",
            "old_card_id" : "9fbea887733623008c5127cb1bf6a791"
        }
    ]

    // execute the main process here
 mainProcess(); 
 
]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2022-06-06 18:03:50&lt;/sys_created_on&gt;
        &lt;sys_id&gt;cdb29f2b53b30110fad4ddeeff7b1229&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Update FSM Mobile To Tokyo&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;25371ef01b8a21109c18a9f9bc4bcb1e&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_cdb29f2b53b30110fad4ddeeff7b1229&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2022-06-06 18:03:50&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 09:40:37</sys_created_on>
        <sys_id>043501d583741210c6695855eeaad3dc</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Update FSM Mobile To Tokyo</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_043501d583741210c6695855eeaad3dc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 09:40:37</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
