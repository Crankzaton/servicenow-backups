<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>e6f7cd8887e033000929717936cb0b21</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Migrate Agent Workspace search sources from the global data model to the modular data model.&amp;#13;
This script checks for search sources already present in Agent workspace and Next Experience Workspace to avoid duplication while migrating active search sources&lt;/description&gt;
        &lt;name&gt;Migrate Agent Workspace Search Sources&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[/*
 * Migrate all active search sources to the Agent Workspace search configuration
 *
 *   In previous releases, Agent Workspace had a global search configuration,
 *   and queried all active search sources.  Now, we support multiple workspaces
 *   where each workspace has its own search configuration.
 */
function migrateAgentWorkspaceSearchSources() {
    var AW_SEARCH_CONFIG_ID = "4961e3e7871033000929717936cb0ba7";
    var NEXT_EXPERIENCE_SEARCH_CONFIG_ID = "c861cea2c7022010099a308dc7c26041";
    var SEARCH_CONFIG_TABLE = "sys_search_context_config";
    var SEARCH_SOURCE_TABLE = "sys_search_source";
    var SEARCH_CONFIG_TO_SOURCE_TABLE = "m2m_search_context_config_search_source";

    // get the agent workspace search configuration

    var awSearchConfig = new GlideRecord(SEARCH_CONFIG_TABLE);
    awSearchConfig.get(AW_SEARCH_CONFIG_ID);

    var configId = awSearchConfig.getValue("sys_id");
    var configName = awSearchConfig.getValue("name");

    gs.debug(configName, "Agent Workspace config name");
    gs.debug(configId, "Agent Workspace config id");

    // get a list of sources already associated to the agent workspace search configuration and Next experience configuration

    var awSourceJoins = new GlideRecord(SEARCH_CONFIG_TO_SOURCE_TABLE);
    var sacQC = awSourceJoins.addQuery("search_context_config", AW_SEARCH_CONFIG_ID);
    sacQC.addOrCondition("search_context_config", NEXT_EXPERIENCE_SEARCH_CONFIG_ID);
    awSourceJoins.query();

    var awSourceIds = [];
    while (awSourceJoins.next()) {
        var awSourceId = awSourceJoins.getValue("source");
        awSourceIds.push(awSourceId);
    }

    gs.debug(awSourceIds, "Agent Workspace &amp; Next Experience search sources");

    // get a list of all active search sources that are not present in either Agent Workspace or Next Experience

    var allActiveSources = new GlideRecord(SEARCH_SOURCE_TABLE);
    allActiveSources.addActiveQuery();
    allActiveSources.addQuery('sys_id', 'NOT IN', awSourceIds.join(','));
    allActiveSources.orderBy("sys_created_on");
    allActiveSources.query();

    // for each active search source, if it's not already associated to the
    // Agent Workspace configuration or Next Experience, add it.

    var order = 0;
    while (allActiveSources.next()) {
        var activeSourceId = allActiveSources.getValue("sys_id");
        order += 100;
        gs.debug(activeSourceId, "adding source to Agent Workspace config");
        awSourceJoins.initialize();
        awSourceJoins.search_context_config = AW_SEARCH_CONFIG_ID;
        awSourceJoins.source = activeSourceId;
        awSourceJoins.order = order;
        awSourceJoins.insert();

    }
}

migrateAgentWorkspaceSearchSources();]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2019-03-27 16:35:44&lt;/sys_created_on&gt;
        &lt;sys_id&gt;e6f7cd8887e033000929717936cb0b21&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;5&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Migrate Agent Workspace Search Sources&lt;/sys_name&gt;
        &lt;sys_package display_value="Agent Workspace" source="sn_agent_workspace"&gt;2b3a837a0bb732007a0e41d6f6673a7f&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Agent Workspace"&gt;2b3a837a0bb732007a0e41d6f6673a7f&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_e6f7cd8887e033000929717936cb0b21&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2022-07-06 17:05:42&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 09:41:41</sys_created_on>
        <sys_id>77658dd583741210c6695855eeaad3d6</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Migrate Agent Workspace Search Sources</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_77658dd583741210c6695855eeaad3d6</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 09:41:41</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
