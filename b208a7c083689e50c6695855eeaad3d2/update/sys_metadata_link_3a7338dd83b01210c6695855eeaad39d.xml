<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>a28c0fbe5bd01010681ced35cc81c7eb</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;This script is to migrate the Signal data from 
1. Search Event ( sys_search_event ) to Search Signal Events table ( sys_search_signal_event ) and 
2. Search Results Clicked (sys_search_result_clicked) to Search Signal Result Event table ( sys_search_signal_result_event) &lt;/description&gt;
        &lt;name&gt;Migrate Search Signal Data&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[function getSignalEventSysId(searchEvent) {
    var g = new GlideRecord('sys_search_signal_event');
    g.addQuery('search_event', searchEvent);
    g.query();
    g.next();

    return g.getUniqueValue();
}

function populateSearchSignalEvent() {
    var searchEventGr = new GlideRecord('sys_search_event');
    searchEventGr.query();

    while (searchEventGr.next()) {
        var searchEventSysId = searchEventGr.getUniqueValue();
        var browser = searchEventGr.getValue("browser");
        var latitude = searchEventGr.getValue("latitude");
        var longitude = searchEventGr.getValue("longitude");
        var searchResults = searchEventGr.getValue("search_results");

        var searchSignalEventGr = new GlideRecord('sys_search_signal_event');
        if (!searchSignalEventGr.get('search_event', searchEventSysId)) {
            searchSignalEventGr.initialize();
            searchSignalEventGr.setValue("search_event", searchEventSysId);
            searchSignalEventGr.setValue("browser", browser);
            searchSignalEventGr.setValue("latitude", latitude);
            searchSignalEventGr.setValue("longitude", longitude);
            searchSignalEventGr.setValue("searchResults", searchResults);

            searchSignalEventGr.insert();
        }
    }
}

function populateSearchSignalResultEvent() {
    var resultClickedGr = new GlideRecord('sys_search_result_clicked');
    resultClickedGr.query();

    while (resultClickedGr.next()) {
        var searchEvent = resultClickedGr.getValue("search_event");
        var resultDocId = resultClickedGr.getValue("result_doc_id");
        var description = resultClickedGr.getValue("label_description");
        var sourceTable = resultClickedGr.getValue("source_table");
        var clickIndex = resultClickedGr.getValue("click_index");

        var searchSignalEventSysId = getSignalEventSysId(searchEvent);

        var resultEventGr = new GlideRecord('sys_search_signal_result_event');
        if (!(resultEventGr.get('search_signal_event', searchSignalEventSysId) &amp;&amp;
                resultEventGr.get('label_description', description))) {
			
            resultEventGr.initialize();
            resultEventGr.setValue("result_doc_id", resultDocId);
            resultEventGr.setValue("label_description", description);
            resultEventGr.setValue("source_table", sourceTable);
            resultEventGr.setValue("search_signal_event", searchSignalEventSysId);
            resultEventGr.setValue("ais_doc_id", null);

            var searchSignalResultEventSysId = resultEventGr.insert();
            if (searchSignalResultEventSysId != null) {
                populateSearchSignalResultEventAction(searchSignalResultEventSysId, clickIndex);
            }
        }
    }
}

function populateSearchSignalResultEventAction(searchSignalResultEventSysId, clickIndex) {
    var resultEventActionGr = new GlideRecord('sys_search_signal_result_event_action');
    if (!resultEventActionGr.get('search_signal_result_event', searchSignalResultEventSysId)) {
        resultEventActionGr.initialize();
        resultEventActionGr.setValue("search_signal_result_event", searchSignalResultEventSysId);
        resultEventActionGr.setValue("signal_type", "CLICK");
        resultEventActionGr.setValue("signal_value", clickIndex);
        resultEventActionGr.insert();
    }
}

populateSearchSignalEvent();
populateSearchSignalResultEvent();]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2020-04-24 22:49:26&lt;/sys_created_on&gt;
        &lt;sys_id&gt;a28c0fbe5bd01010681ced35cc81c7eb&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;5&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Migrate Search Signal Data&lt;/sys_name&gt;
        &lt;sys_package display_value="Search Signal Event Data" source="com.glide.search.signal_data"&gt;2704fc283c31311068bcf327dfe37f94&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_a28c0fbe5bd01010681ced35cc81c7eb&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2020-04-26 16:31:40&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:23:15</sys_created_on>
        <sys_id>3a7338dd83b01210c6695855eeaad39d</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Migrate Search Signal Data</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_3a7338dd83b01210c6695855eeaad39d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:23:15</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
