<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>097f1a8193210200d9b9941e867ffb4e</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;sn_appauthor.ScopedAppPackageSuppressor&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Determines if a specific application record should be suppressed during the packaging of an application.&lt;/description&gt;
        &lt;name&gt;ScopedAppPackageSuppressor&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var ScopedAppPackageSuppressor = Class.create();
ScopedAppPackageSuppressor.prototype = {
    initialize: function (sys_app) {
        this.app = sys_app;
        this.log = true;
    },

    suppress: function (gr) {
		var className = gr.getRecordClassName();
        if (className === 'wf_workflow')
            return this._workflowHasNoPublishedVersions(gr);
        if (className === 'sys_choice_set')
            return this._choicesOnElementNotInherited(gr);
        if (className === 'sys_scope_privilege')
            return this._screenInvalidCrossScopePrivileges(gr);
		if (className === 'sys_ui_list' || className == 'sys_ui_form')
			return this._screenRecordIsUserConfig(gr);

        return false;
    },

    setQuiet: function (quiet) {
        this.log = !quiet;
    },

    _workflowHasNoPublishedVersions: function (workflow) {
        var workflowVersion = new GlideRecord('wf_workflow_version');
        workflowVersion.addQuery('workflow', workflow.getUniqueValue());
        workflowVersion.addQuery('published', true);
        workflowVersion.query();
        var numPublishedVersions = workflowVersion.getRowCount();
        if (numPublishedVersions &gt; 0)
            return false;

        if (this.log)
            gs.info("The '{0}' workflow will not be published with the '{1}' application. The workflow has no published versions.", [workflow.sys_name.toString(), this.app.name.toString()]);

        return true;
    },

    _choicesOnElementNotInherited: function(choiceSet) {
        var cs = new GlideRecord('sys_choice_set');
        if (!cs.get(choiceSet.getUniqueValue()))
            return true; //suppress this metadata record because its invalid

        //For newer versions use the element descriptor
        var ge = new GlideElementDescriptor();
        if (typeof ge.getFirstTableName != 'undefined') {
            // Can no longer rely on dictionary entry to determine inheritance.  If it is not inherited,
            // its choices will be unloaded as part of the table's bootstrap XML file
            var targetTable = new GlideRecord(cs.name.toString());
            var targetField = cs.element.toString();
            if (targetTable.isValid() &amp;&amp; targetTable.isValidField(targetField)) {
                var ed = targetTable.getElement(targetField).getED();
                return ed.getFirstTableName() == targetTable.getTableName();
            }
        } else {
            // if dictionary entry exists then the choice set element is not inherited
            // and its choices will be unloaded as part of the table's bootstrap XML file
            var dictionary = new GlideRecord('sys_dictionary');
            dictionary.addQuery('name', cs.name.toString());
            dictionary.addQuery('element', cs.element.toString());
            dictionary.query();
            return dictionary.hasNext();
        }

        return true;
    },

    _screenInvalidCrossScopePrivileges: function (metadata) {
        var privilege = this._getChildClassRecord('sys_scope_privilege', metadata);
        var appId = this.app.getUniqueValue();
        if (privilege.isValidRecord()) {
            if (privilege.getValue('sys_scope') != appId)
                return true;
            if (privilege.getValue('source_scope') != appId)
                return true;
            if (privilege.getValue('status') != 'allowed')
                return true;
        }
        return false;
    },
	
	_screenRecordIsUserConfig : function (metadata) {
		var ui_record = this._getChildClassRecord(metadata.getRecordClassName(), metadata);
		if (ui_record.isValidField('sys_user'))
			return !gs.nil(ui_record.getValue('sys_user'));
		if (ui_record.isValidField('user'))
			return !gs.nil(ui_record.getValue('user'));
		
		return false;
	},

    _getChildClassRecord: function (childClass, gr) {
        if (gr.getTableName() == childClass)
            return gr;
        var childClassRecord = new GlideRecord(childClass);
        childClassRecord.get('sys_id', gr.getUniqueValue());
        return childClassRecord;
    },

    type: 'ScopedAppPackageSuppressor'
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2015-07-27 21:19:31&lt;/sys_created_on&gt;
        &lt;sys_id&gt;097f1a8193210200d9b9941e867ffb4e&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;18&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;ScopedAppPackageSuppressor&lt;/sys_name&gt;
        &lt;sys_package display_value="Scoped App Author" source="sn_appauthor"&gt;893ea311d71321004f6a0eca5e6103e6&lt;/sys_package&gt;
        &lt;sys_policy&gt;read&lt;/sys_policy&gt;
        &lt;sys_scope display_value="Scoped App Author"&gt;893ea311d71321004f6a0eca5e6103e6&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_097f1a8193210200d9b9941e867ffb4e&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2019-10-14 20:22:12&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:09:38</sys_created_on>
        <sys_id>df50749583b01210c6695855eeaad3f4</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>ScopedAppPackageSuppressor</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_df50749583b01210c6695855eeaad3f4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:09:38</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
