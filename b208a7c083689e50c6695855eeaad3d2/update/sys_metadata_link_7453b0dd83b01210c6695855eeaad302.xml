<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>8b42fd8453d52110af64ddeeff7b1295</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;This script captures the data from XML field on the records of 'CMDB Baseline Entry' table and copies it to a new attachment on the same record. Only one attachment will be created if and only if there is no attachment already. Once eveyrthing is converted, please set following property to true: com.cmdb.baseline.entry.attachment
After setting that property to true, 'CMDB Baseline Diff' formatter will be using the attachment to find the diff and read the XML in streaming fashion to avoid excessive memory usage. If the property is set to false, it will fallback to using old code which uses existing XML field to find the diff, and which can use more memory.&lt;/description&gt;
        &lt;name&gt;CMDB Baseline convert XML to attachment&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[function copyBLEXMLToAttachment(entryId) {
    // check for baseline entry record
    var grBLEntry = new GlideRecord('cmdb_baseline_entry');
    if (!grBLEntry.get(entryId)) {
        gs.log('Failed to find Baseline entry record for sys_id:' + entryId);
        return;
    }

    // check for existing attachment for baseline entry record
    var grAttachment = new GlideRecord('sys_attachment');
    grAttachment.addEncodedQuery('table_name=cmdb_baseline_entry^table_sys_id=' + entryId);
    grAttachment.query();
    if (grAttachment.getRowCount() != 0) {
        gs.log('Found existing attachment(s) for baseline entry record with sys_id:' + entryId);
        return;
    }

    // validate XML data
    var xmlString = grBLEntry.getValue('baseline_xml');
    if (!xmlString || xmlString.toString() == "") {
        gs.log('No data found in XML field for baseline entry with sys_id:' + entryId);
        return;
    }
	try{
		var xmlDoc = new XMLDocument2();
		xmlDoc.parseXML(xmlString);
		if (!xmlDoc || xmlDoc.toString() == "") {
			gs.log('Contents of XML field are not valid XML for baseline entry with sys_id:' + entryId);
			return;
		}
	} catch(err) {
		gs.error('Problem parsing XML field for CMDB Baseline Entry with sys_id:' + entryId + '. Error:' + err.message);
		return;
	}

    // create the attachment
    var att = new GlideSysAttachment();
    var attachmentId = att.write(grBLEntry, 'xml_' + entryId + '.xml', 'application/xml', xmlDoc.toString());
    gs.log('Attachment created successfully with attachment sys_id:' + attachmentId);
}

if(gs.getProperty('com.cmdb.baseline.entry.attachment')) {
    var grEntry = new GlideRecord('cmdb_baseline_entry');
    grEntry.orderBy('baseline');
    grEntry.query();
    while (grEntry.next()) {
        copyBLEXMLToAttachment(grEntry.getUniqueValue());
    }
} else {
    gs.log('com.cmdb.baseline.entry.attachment property is not set to true, so skipping attachment creation for baseline entries. Please, run this fix script after enabling that property');
}
]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2023-02-23 23:48:26&lt;/sys_created_on&gt;
        &lt;sys_id&gt;8b42fd8453d52110af64ddeeff7b1295&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;4&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;CMDB Baseline convert XML to attachment&lt;/sys_name&gt;
        &lt;sys_package display_value="Configuration Management (CMDB)" source="com.snc.cmdb"&gt;8f64bce83c31311068bcf327dfe37f7e&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_8b42fd8453d52110af64ddeeff7b1295&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2023-04-17 16:40:50&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:22:34</sys_created_on>
        <sys_id>7453b0dd83b01210c6695855eeaad302</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>CMDB Baseline convert XML to attachment</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_7453b0dd83b01210c6695855eeaad302</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:22:34</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
