<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>40f4db19075230105a57aece1ad300bb</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Adds reservable view configuration records to all reservable modules.  By default all modules will get card and schedule view, if show_on_map is set to true on reservable module will also configure map view.&lt;/description&gt;
        &lt;name&gt;Configure reservable views for modules&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[var RESERVABLE_VIEWS = {CARD: 'e7903812074230105a57aece1ad300fc', SCHEDULE: '3f123812074230105a57aece1ad30048', MAP: 'c7223812074230105a57aece1ad3004b'};
// Sys ids of reservable module demo data, Desk within area, Desks, Meeting rooms, Desks within shift, Meeting rooms require approval
var DEMO_DATA_MODULES = ['2b636b7e1b4e60103523ff751a4bcbe2', '5db44502dbb650106c731dcd13961937', 'c31241cedb7650106c731dcd13961917', 'fc71f64fdb42a01097acc900399619a8', 'ff51c98edb7650106c731dcd13961984'];

configureReservableViewsForAllModules();

/**
 * Configures reservable views for all reservable modules with no reservable view associated with them.
 * If error occurs during creation will log error.
 */
function configureReservableViewsForAllModules() {
	var moduleGr = new GlideRecord(WSDConstants.TABLES.ReservableModule.name);
	moduleGr.addQuery('sys_id', 'NOT IN', DEMO_DATA_MODULES.join());
	moduleGr.query();
	while(moduleGr.next()) {
		var moduleId = moduleGr.getUniqueValue();
		var moduleViewGr = new GlideRecord(WSDConstants.TABLES.ReservableModuleViewConfiguration.name);
		moduleViewGr.addQuery('reservable_module', moduleId);
		moduleViewGr.query();

		// If module already has a ReservableModuleViewConfiguration record associated go to next module.
		if (moduleViewGr.hasNext())
			continue;

		// Card view
		var cardViewCreated = createReservableModuleViewConfigurationRecord(RESERVABLE_VIEWS.CARD, moduleId, 1, true);
		if(!cardViewCreated)
			WSDLogger.error('Fix Script: Configure reservable views for modules', 'Failed to configure card reservable view for module.', {reservable_view: RESERVABLE_VIEWS.CARD, reservable_module:moduleId, lastErrorMessage: moduleViewGr.getLastErrorMessage()});

		// Schedule view
		var scheduleViewCreated = createReservableModuleViewConfigurationRecord(RESERVABLE_VIEWS.SCHEDULE, moduleId, 2, false);
		if(!scheduleViewCreated)
			WSDLogger.error('Fix Script: Configure reservable views for modules', 'Failed to configure schedule reservable view for module.', {reservable_view: RESERVABLE_VIEWS.SCHEDULE, reservable_module:moduleId, lastErrorMessage: moduleViewGr.getLastErrorMessage()});

		// Map view
		if (WSDUtils.safeBool(moduleGr.getValue('show_map_view'))) {
			var mapViewCreated = createReservableModuleViewConfigurationRecord(RESERVABLE_VIEWS.MAP, moduleId, 3, false);
			if(!mapViewCreated)
				WSDLogger.error('Fix Script: Configure reservable views for modules', 'Failed to configure map reservable view for module.', {reservable_view: RESERVABLE_VIEWS.MAP, reservable_module:moduleId, lastErrorMessage: moduleViewGr.getLastErrorMessage()});

		}
	}
}

/**
 * Creates a reservable module view configuration record with provided values.
 * @param {string} reservableView - Sys id of the reservable view.
 * @param {string} reservableModule - Sys id of the reservable module.
 * @param {number} order - Order in which the button should appear.
 * @param {boolean} isDefault - Flag if the record should be the default.
 * @returns {boolean} - True if record inserted correctly.
 */
function createReservableModuleViewConfigurationRecord(reservableView, reservableModule, order, isDefault) {
	var moduleViewGr = new GlideRecord(WSDConstants.TABLES.ReservableModuleViewConfiguration.name);
	moduleViewGr.setValue('reservable_view', reservableView);
	moduleViewGr.setValue('reservable_module', reservableModule);
	moduleViewGr.setValue('order', order);
	moduleViewGr.setValue('is_default', isDefault);

	return moduleViewGr.insert() ? true : false;
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2021-08-30 08:42:57&lt;/sys_created_on&gt;
        &lt;sys_id&gt;40f4db19075230105a57aece1ad300bb&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;4&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Configure reservable views for modules&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;e9b477e9c3161010cc7060bf4b40dded&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value=""&gt;e9b477e9c3161010cc7060bf4b40dded&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_40f4db19075230105a57aece1ad300bb&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-09-07 11:46:34&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:20:36</sys_created_on>
        <sys_id>7fd27c5d83b01210c6695855eeaad304</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Configure reservable views for modules</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_7fd27c5d83b01210c6695855eeaad304</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:20:36</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
