<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>099527f7701e47268b779e2a4334ab7d</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Generates portfolfio field mapping for the internal intergration tables project and demand&lt;/description&gt;
        &lt;name&gt;GeneratePortfolioFieldMap&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[
      function generatePortfolioMap(ppmTable, portfolioField, integration) {
          var tableMapGr = new GlideRecord("sn_align_cmn_int_table_map");
          tableMapGr.addQuery("execution_table", ppmTable);
          tableMapGr.addQuery("integrations_setup", integration);
          tableMapGr.query();
          if(!tableMapGr.next()) {
            gs.info("Integration table map has NOT been found for " +  ppmTable);
            return;
          }

          var tableMap = tableMapGr.getUniqueValue();
          var fieldMapGr = new GlideRecord("sn_align_cmn_int_field_map");
          fieldMapGr.addQuery("execution_table_column", portfolioField);
          fieldMapGr.addQuery("table_map", tableMap);
          fieldMapGr.query();
          
          if(fieldMapGr.next()) {
          gs.warn("Portfolio field mapping already exists in the system so avoiding adding an another mappping. To make Legacy Lens of Portfolio Planning work, please remove the existing portfolio mapping and add one for pm_portfolio field of the planning item table.");
          return;
          }
          gs.info("Portfolio mapping has NOT been found.");
          fieldMapGr.newRecord();
          fieldMapGr.setValue("table_map", tableMap);
          fieldMapGr.setValue("execution_table_column", portfolioField);
          fieldMapGr.setValue("external_field", portfolioField);
          fieldMapGr.setValue("external_field_name", portfolioField);
          fieldMapGr.setValue("internal_field", "pm_portfolio");
          if(fieldMapGr.insert()) {
            gs.info("Portfolio mapping has been inserted for "+ ppmTable);
          }
      }

      var integration = new GlideRecord("sn_align_cmn_int_integrations_setup");
      integration.addQuery("active", true);
      integration.addQuery("type", "internal");
      integration.query();
      if(integration.next()) {
        generatePortfolioMap("pm_project", "primary_portfolio", integration.getUniqueValue());
        generatePortfolioMap("dmn_demand", "portfolio", integration.getUniqueValue());
      } else {
          gs.info("An active internal integration for Portfolio planning has NOT been found");
      }
    ]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2022-12-15 15:08:32&lt;/sys_created_on&gt;
        &lt;sys_id&gt;099527f7701e47268b779e2a4334ab7d&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;GeneratePortfolioFieldMap&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;b48fff4887143010fb4b3a0548cb0b43&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value=""&gt;b48fff4887143010fb4b3a0548cb0b43&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_099527f7701e47268b779e2a4334ab7d&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2022-12-15 15:08:32&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:19:00</sys_created_on>
        <sys_id>54823c1d83b01210c6695855eeaad351</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>GeneratePortfolioFieldMap</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_54823c1d83b01210c6695855eeaad351</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:19:00</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
