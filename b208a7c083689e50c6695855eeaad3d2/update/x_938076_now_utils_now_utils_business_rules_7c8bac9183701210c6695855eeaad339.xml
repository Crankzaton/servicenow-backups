<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="x_938076_now_utils_now_utils_business_rules">
    <x_938076_now_utils_now_utils_business_rules action="INSERT_OR_UPDATE">
        <abort_action>false</abort_action>
        <access>package_private</access>
        <action_delete>true</action_delete>
        <action_insert>false</action_insert>
        <action_query>false</action_query>
        <action_update>false</action_update>
        <active>true</active>
        <add_message>false</add_message>
        <advanced>true</advanced>
        <change_fields>false</change_fields>
        <client_callable>false</client_callable>
        <collection/>
        <condition/>
        <description>When we manually remove assessable records from metric category, we need to automatically update category users for  metric categories and update stakeholders for this assessable record.

For add operation, please check business rule called "Auto add category users".</description>
        <execute_function>false</execute_function>
        <filter_condition/>
        <is_rest>false</is_rest>
        <message/>
        <name>Auto remove category users</name>
        <order>100</order>
        <priority>100</priority>
        <rest_method/>
        <rest_method_text/>
        <rest_service/>
        <rest_service_text/>
        <rest_variables/>
        <role_conditions/>
        <script><![CDATA[(function executeRule(current, previous /*null when async*/) {
 var asmtUtil = new global.AssessmentUtils();
 
 // Get category
 var metricCategory = new GlideRecord("asmt_metric_category");
 metricCategory.get(previous.category);
 
 // Get assessable record
 var assessableRecord = new GlideRecord("asmt_assessable_record");
 assessableRecord.get(previous.assessment_record);
 
 // Get asmt metric type
 var metricType = new GlideRecord("asmt_metric_type");
 metricType.get(metricCategory.metric_type);
 
 // Get user(assessor) from assessable record
 var userIds = asmtUtil.getAssessorFromAssessableRecord(assessableRecord.sys_id, metricType.user_field);
 
 if (!userIds)
  return;
 var userIdsrArr = userIds.split(",");
 for (var i=0 ; i < userIdsrArr.length; i++) {
  if (!GlideStringUtil.isEligibleSysID(userIdsrArr[i]))
   continue;
  // Remove category user from metric category
  var catUser = asmtUtil.getM2mCategoryUserByCategoryAndUser(metricCategory.sys_id, userIdsrArr[i]);
  if (catUser.next()) {
   // Check if there is other assessable record using this category user; If not, remove this category user from metric category
   var catAsmt = asmtUtil.getM2mCategoryAssessmentByCategory(metricCategory.sys_id);
   var catAsmtRec = [];
   while (catAsmt.next()) {
    if (catAsmt.assessment_record == assessableRecord.sys_id)
     continue;
    catAsmtRec.push(catAsmt.assessment_record + '');
   }
   //If there is only one assessable record using this category user (the removed one), we can delete this category user from current metric category
   var stakeholder = new GlideRecord("asmt_m2m_stakeholder");
   stakeholder.addQuery("category_user", catUser.sys_id);
   stakeholder.addQuery("assessment_record", "IN", catAsmtRec);
   stakeholder.setLimit(1);
   stakeholder.query();
   if (!stakeholder.hasNext()) {
    catUser.deleteRecord();
   }
  }
 }
 
})(current, previous);]]></script>
        <sys_class_name>x_938076_now_utils_now_utils_business_rules</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 07:48:26</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>7c8bac9183701210c6695855eeaad339</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Auto remove category users</sys_name>
        <sys_overrides/>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>x_938076_now_utils_now_utils_business_rules_7c8bac9183701210c6695855eeaad339</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 07:48:26</sys_updated_on>
        <template/>
        <when>before</when>
    </x_938076_now_utils_now_utils_business_rules>
    <sys_translated_text action="delete_multiple" query="documentkey=7c8bac9183701210c6695855eeaad339"/>
</record_update>
