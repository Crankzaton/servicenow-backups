<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>8a53f4129f0302003be01050a57fcf0c</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Migrate Knowledge V2 Topic and Category to KnowledgeV3 category&lt;/description&gt;
        &lt;name&gt;Migrate KnowledgeV2 Topic and Category &lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[// - we want to create categories only within the  same Default Knowledge
// - also the topic should be top level kb_category and category should be the next level
var target = new GlideRecord('kb_knowledge');
target.addQuery('kb_knowledge_base', 'dfc19531bf2021003f07e2c1ac0739ab');
target.query();

while (target.next()) {
	gs.log(target.short_description);
	if(target.kb_category){
		gs.log("Kb Category already exists");
		continue;
	}
	var topic = target.topic;
	var category = target.category;
	gs.log(topic+" =&gt; " + category);
	
	// ---- check if topic &amp; category is present in category
	var catRec = lookupTopicAndCategory(topic,category);
	target.kb_category = catRec.sys_id;
	target.update();
}

// -----------------------------
function lookupCategory(category, parentSysId) {
	gs.log("===================== lookup category: " + category + " ========================");
	var target = new GlideRecord('kb_category');
	var q = "value=" + category + "^parent_id=" + parentSysId;
	gs.log(q);
	target.addEncodedQuery(q);
	target.query();
	while(target.next()) {
		gs.log(target.sys_id + " -- " + target.value + " -- " + target.label);
		return target;
	}
	return undefined;
}

function lookupTopicAndCategory(topic, category) {
	gs.log("===================== lookup " + topic + "," + category + " ========================");
	if(!topic || topic.trim().length &lt;= 0)
		return;
	var defaultKB = 'dfc19531bf2021003f07e2c1ac0739ab';
	var topicRec = lookupCategory(topic, defaultKB);
	// if no topic, lets create one
	if(!topicRec) {
		topicRec=createCategory(topic,topic, defaultKB, 'kb_knowledge_base');
	}
	gs.log(topicRec.sys_id);
	gs.log(topicRec.parent_id);
	gs.log(topicRec.label);
	
	if(!category || category.trim().length &lt;= 0){
		return topicRec;
	}
	// lets check the category - second level
	var catRec = lookupCategory(category, topicRec.sys_id);
	if(!catRec) {
		catRec = createCategory(category, category, topicRec.sys_id, 'kb_category');
	}
	return catRec;
}

function createCategory(lbl, val, parentSysId, type) {
	gs.log("==&gt; Create " + lbl + ", val:"+val+", sys_id:"+parentSysId);
	if(!lbl || !val || lbl.trim().length&lt;=0 || val.trim().length&lt;=0) return;
		var gr = new GlideRecord('kb_category');
	gr.initialize();
	gr.setValue('label',lbl);
	gr.setValue('value', val);
	gr.setValue('parent_id', parentSysId);
	gr.setValue('parent_table', type);
	gr.insert();
	gs.log("----------- created ----- " + gr.sys_id + "  ------------------ " + gr.parent_id);
	return gr;
}


]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2015-10-14 00:09:01&lt;/sys_created_on&gt;
        &lt;sys_id&gt;8a53f4129f0302003be01050a57fcf0c&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;10&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Migrate KnowledgeV2 Topic and Category &lt;/sys_name&gt;
        &lt;sys_package display_value="Knowledge Management Core" source="com.glideapp.knowledge"&gt;a8c6f4a43cb1311068bcf327dfe37f3e&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_8a53f4129f0302003be01050a57fcf0c&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2015-10-14 18:03:07&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:22:33</sys_created_on>
        <sys_id>985370dd83b01210c6695855eeaad39a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Migrate KnowledgeV2 Topic and Category </sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_985370dd83b01210c6695855eeaad39a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:22:33</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
