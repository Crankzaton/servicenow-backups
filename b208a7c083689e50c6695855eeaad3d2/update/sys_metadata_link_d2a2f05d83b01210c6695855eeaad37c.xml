<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>2213a3dfc713ad10c636edf4c1c26005</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;fix script to run after upgrade to Utah&lt;/description&gt;
        &lt;name&gt;Field service mobile upgrade script&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[function mainProcess() {
	removeInputParamMapforAssetLookup();
	removeDupWORelatedList();
    setDetailOffline();
}

function removeDupWORelatedList(){
	gs.info("processing Remove Dup WORelatedList Utah upgrade: ");
    var FORM_SEGMENT_TABLE = "sys_sg_form_segment";
    var RELATED_LIST_MAP_TABLE = "sys_sg_related_list_map";

    /**
     * old work order related list
     * Affected CIs: sys_sg_related_list_map_1e1ad7a6e7c1230003cd6188d2f6a970.xml
     *               sys_sg_list_screen_bb4c63b253b0330097a2ddeeff7b122a.xml
     * Task SLA: sys_sg_related_list_map_de0a0d0ae781230003cd6188d2f6a9a5.xml
     *           sys_sg_list_screen_c03c2f7253b0330097a2ddeeff7b12ec.xml
     * Related work order: sys_sg_related_list_map_2a12e8abe7b2101074246188d2f6a9e1.xml
     *                     sys_sg_list_screen_e25160abe7b2101074246188d2f6a938.xml
     * sys_sg_form_segment_6c4cef7253b0330097a2ddeeff7b1269.xml 
     * Old related lists: sys_sg_related_lists_screen_6b89490ae781230003cd6188d2f6a9de.xml
     */
    var OLD_WO_RELATED_LIST = "6b89490ae781230003cd6188d2f6a9de";
    var OLD_WO_RELATED_MAP = ["1e1ad7a6e7c1230003cd6188d2f6a970", "de0a0d0ae781230003cd6188d2f6a9a5", "2a12e8abe7b2101074246188d2f6a9e1"];
    var OLD_WO_FORM_SEGMENT = "6c4cef7253b0330097a2ddeeff7b1269";

    //sys_sg_form_segment_6f03886ac7b49110c636edf4c1c26073.xml
    var NEW_WO_FORM_SEGMENT = "6f03886ac7b49110c636edf4c1c26073";

    var woRLMap = new GlideRecord(RELATED_LIST_MAP_TABLE);
    woRLMap.addQuery("related_list_screen", OLD_WO_RELATED_LIST);
    woRLMap.query();
    var existingMap = [];
    var existingScreen = [];
    while (woRLMap.next()) {
        var existing = woRLMap.getUniqueValue();
        existingMap.push(existing);
        var screen = woRLMap.getValue("destination_screen");
        existingScreen.push(screen);
    }

    if ( (existingMap.length &gt; 0) &amp;&amp; (existingMap.length != OLD_WO_RELATED_MAP.length) ) {
        deleteNotUsed(FORM_SEGMENT_TABLE, NEW_WO_FORM_SEGMENT);
        return;
    }

    var diffMap = false;
    for (var i = 0; i &lt; existingMap.length; i++) {
        if (OLD_WO_RELATED_MAP.indexOf(existingMap[i]) == -1) {
            diffMap = true;
            break;
        }
    }

    var modifiedScreen = false;
    var gcd = new global.CollisionDetectorDelegate();
    for (var j = 0; j &lt; existingScreen.length; j++) {
        var fileName = "sys_sg_list_screen_" + existingScreen[j];
        if (gcd.containsKey(fileName)) {
            modifiedScreen = true;
            break;
        }
    }

    var customized = (diffMap || modifiedScreen);

    if (customized == true) {
        deleteNotUsed(FORM_SEGMENT_TABLE, NEW_WO_FORM_SEGMENT);
    } else {
        deleteNotUsed(FORM_SEGMENT_TABLE, OLD_WO_FORM_SEGMENT);
    }	
}

function removeInputParamMapforAssetLookup(){
	gs.info("executing Upgrade utah fix asset lookup: ");
   var INPUT_VARIABLE_PARAM_MAP_TABLE = "sys_sg_input_variable_param_map";
	var ITEM_TO_REMOVE = "83e364b797211110decc718e6253af39";
	var ASSET_LOOKUP_LIST_SCREEN_ID = "8e3caf7253b0330097a2ddeeff7b1203";

    var screenRecord = new GlideRecord("sys_sg_list_screen");
    screenRecord.get(ASSET_LOOKUP_LIST_SCREEN_ID);
	var inputform = screenRecord.getValue("parameter_screen");
	//sys_sg_input_variable_param_map is for input screen.  
	//if there's no input screen we can delette the map
	if (gs.nil(inputform)){
		deleteNotUsed(INPUT_VARIABLE_PARAM_MAP_TABLE, ITEM_TO_REMOVE);
	}
}

function deleteNotUsed(table, record) {
    var delGr = new GlideRecord(table);
    if (delGr.get(record)) {
       delGr.deleteRecord();
    }
}

// set offline availablity to false for  Detail Screen records with a null table
function setDetailOffline(){
    var detailRec = new GlideRecord("sys_sg_details_screen");
    detailRec.addEncodedQuery("nameSTARTSWITHdetails^tableLIKEnull^ORtableISEMPTY");
    detailRec.query();
    while (detailRec.next()) {
        gs.info("Set offline availablity to false for sys_sg_details_screen id : " + detailRec.getValue("sys_id"));
        detailRec.setValue("available_offline", false);
        detailRec.update();
    }
}



mainProcess();]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2023-06-13 20:28:04&lt;/sys_created_on&gt;
        &lt;sys_id&gt;2213a3dfc713ad10c636edf4c1c26005&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;3&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Field service mobile upgrade script&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;25371ef01b8a21109c18a9f9bc4bcb1e&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_2213a3dfc713ad10c636edf4c1c26005&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2023-07-18 20:29:24&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:19:40</sys_created_on>
        <sys_id>d2a2f05d83b01210c6695855eeaad37c</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Field service mobile upgrade script</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_d2a2f05d83b01210c6695855eeaad37c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:19:40</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
