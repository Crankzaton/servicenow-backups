<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>20aecff4c3f3d010766b0bd91f40ddbb</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;public&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.SplitStoryUtil&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description/&gt;
        &lt;name&gt;SplitStoryUtil&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var SplitStoryUtil = Class.create();
SplitStoryUtil.prototype = { 
    initialize: function() {},
    generateNextStoryNumber: function(tableName) {
        var newNumber = new global.NumberManager(tableName);
        return newNumber.getNextObjNumberPadded();
    }, 
    processSaveStory: function(tableName, taskTableName, sprintFieldName, taskParentTable, fieldsObj) {
        var fieldsToCopy = {
            'rm_story': ['release', 'product', 'theme', 'epic', 'acceptance_criteria', 'assigned_to', 'description', 'assignment_group', 'project', 'project_phase'],
            'sn_safe_story': ['sn_safe_feature', 'sn_safe_epic', 'acceptance_criteria', 'assigned_to', 'description', 'enabler', 'assignment_group']
        };
		

        var originalStorySysId = fieldsObj.originalStorySysId;
        var originalStoryPoints = fieldsObj.originalStoryPoints;
        var splitStorySprintSysId = fieldsObj.splitStorySprintSysId;
        var splitStoryPoints = fieldsObj.splitStoryPoints;
        var splitStoryNumber = fieldsObj.splitStoryNumber;
        var splitStoryShortDescription = fieldsObj.splitStoryShortDescription;
        var checkbox = fieldsObj.checkbox;
        var originalStory = new GlideRecord(tableName);
        originalStory.get(originalStorySysId);
        originalStory.setValue('story_points', originalStoryPoints);
        originalStory.update();

        var newStory = new GlideRecord(tableName);
        newStory.initialize();
        newStory.setValue('number', splitStoryNumber);
        newStory.setValue('story_points', splitStoryPoints);
        newStory.setValue('short_description', splitStoryShortDescription);
        newStory.setValue(sprintFieldName, splitStorySprintSysId);
        newStory.setValue('split_from', originalStorySysId);

        var originalStoryValues = {};
        var fields = fieldsToCopy[tableName];
		fields = new global.AgileGlobalUtils().includeAdditionalFields(fields);
        for (var key in fields) {
            var fieldName = fields[key];
            if (originalStory.isValidField(fieldName))
                newStory.setValue(fieldName, originalStory.getValue(fieldName));
        }
        var result = newStory.insert();
        if (!gs.nil(result)) {
            var taskGr = new GlideRecord(taskTableName);
            var taskStateUtil = new global.PlannedTaskStateUtil(taskGr);
            var closedStates = taskStateUtil.getCloseStates();

            if (checkbox) {
                taskGr.addQuery(taskParentTable, originalStorySysId);
                taskGr.addQuery('state', 'NOT IN', closedStates);
                taskGr.query();
                taskGr.setValue(taskParentTable, newStory.sys_id);
                taskGr.updateMultiple();
            }
            var newStorySysId = newStory.sys_id;
            var attachment = new GlideSysAttachment();
            attachment.copy(tableName, originalStorySysId, tableName, newStorySysId);
        }

        return {
            "originalStory": originalStorySysId,
            "split_story_number": splitStoryNumber,
            "newStorySysId": newStorySysId,
            "status": result
        };
    },
    type: 'SplitStoryUtil'
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2020-10-09 16:13:50&lt;/sys_created_on&gt;
        &lt;sys_id&gt;20aecff4c3f3d010766b0bd91f40ddbb&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;30&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;SplitStoryUtil&lt;/sys_name&gt;
        &lt;sys_package display_value="Agile Development 2.0 - Common" source="com.snc.sdlc.agile.2.0.common"&gt;61152b88477e0610cd4e1ce4316d4377&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_20aecff4c3f3d010766b0bd91f40ddbb&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2023-10-17 20:52:14&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:11:54</sys_created_on>
        <sys_id>64e03c1983b01210c6695855eeaad34a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>SplitStoryUtil</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_64e03c1983b01210c6695855eeaad34a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:11:54</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
