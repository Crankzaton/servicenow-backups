<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>31e2bce1eb6811e98758251694724243</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;Fix script to remove additional information Assessment Metric questions for SIG Questionnaire templates. This fix script is required as the additional information is now collected in a field (add_info) on SIG Questions&lt;/description&gt;
        &lt;name&gt;fix_remove_additional_info_questions&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[/**
* 
* Migrate Additional Information questions if the following plugins are active.
*
* com.sn_sig_asmt: GRC: SIG Questionnaire Integration 
* com.sn_sig_app : GRC: SIG Questionnaire
*
*/

	
//SIG Templates with extra Additional Information questions
var SIG_2017_TEMPLATES = [	
	"eaece0a2eb0222009403a638a206fe58", // SIG Full 2017
	"34554855d7022200bbc783e80e61031e"  // SIG Lite 2017
];

var SIG_TEMPLATES = [
	"91837df967a71300e2b3624ad585ef76", // SIG Core 2018
	"2231e43adbd75300d11f77bcbf961900", // SIG Full 2018
	"52a726e2731313003915d8b0caf6a7b4", // SIG Lite 2018
	"eaece0a2eb0222009403a638a206fe58", // SIG Full 2017
	"34554855d7022200bbc783e80e61031e"  // SIG Lite 2017
];

//Driver function
allowAdditionalInfoForAsmtMetrics(SIG_2017_TEMPLATES);
migrateSIGArtifacts(SIG_TEMPLATES);

function migrateSIGArtifacts(sigTemplates) {
	
	//Query Assessment Instances for SIG Templates with Additional Information questions
	var grAsmtInstance = new GlideRecord("asmt_assessment_instance");
	grAsmtInstance.addQuery("metric_type", "IN", sigTemplates);
	grAsmtInstance.query();
	
	//Create an array of all assessment instances created for SIG Questionaire templates with Additional Information questions
	var assessmentInstances = [];

	while(grAsmtInstance.next()) 
		assessmentInstances.push(grAsmtInstance.getUniqueValue() + "");
	
	for (var i = 0; i&lt;assessmentInstances.length; i++) {
		
		//Migrate Additional Information for asmt_metric_result
		migrateAdditionalInformation(assessmentInstances[i], "asmt_metric_result");
		
		//Migrate Additional Information for asmt_assessment_instance_question
		migrateAdditionalInformation(assessmentInstances[i], "asmt_assessment_instance_question");
	}
	/**
	* 
	* Drop Additional Information questions for asmt_metric
	*
	* The reason to drop additional information question after dropping 
	* asmt_metric_result and asmt_assessment_instance_question 
	* is to clear all dependencies of asmt_metric before deleting additional questions. 
	* This will ensure that there are no dependency errors while dropping asmt_metric record(s)
	*
	*/
	dropAdditionalInfoMetrics(sigTemplates);
}    

function migrateAdditionalInformation(assessmentSysId, tableName) {

	var serialNumbers = {};
	
	var gr = new GlideRecord(tableName);
	gr.addQuery("instance", assessmentSysId);
	gr.addQuery("metric.question", "ENDSWITH", "Additional Information");
	gr.query();
	
	while (gr.next()) {
		serialNumbers[gr.metric.sn_sig_asmt_serial_number] = gr.string_value + "";
		gr.deleteRecord();
	}
	
	var grNonAdditional = new GlideRecord(tableName);
	grNonAdditional.addQuery("instance", assessmentSysId);
	grNonAdditional.addQuery("metric.sn_sig_asmt_serial_number", "IN", Object.keys(serialNumbers) + "");
	grNonAdditional.query();
	
	while (grNonAdditional.next()) {
		grNonAdditional.setValue("add_info", serialNumbers[grNonAdditional.metric.sn_sig_asmt_serial_number]);
		grNonAdditional.update();  
	}
}

function dropAdditionalInfoMetrics(sigTemplates) {
	
	var grMetric = new GlideRecord('asmt_metric');
	grMetric.addQuery("metric_type", "IN", sigTemplates);
	grMetric.addQuery("question", "ENDSWITH", "Additional Information");
	grMetric.query();
	grMetric.deleteMultiple();
}

function allowAdditionalInfoForAsmtMetrics(sigTemplates) {
	var grAsmtMetric = new GlideRecord('asmt_metric');
	grAsmtMetric.addQuery('metric_type', 'IN', sigTemplates);
	grAsmtMetric.query();
	
	grAsmtMetric.setValue('allow_add_info', 'true');
	grAsmtMetric.setValue('add_info_label', 'Additional Information');
	grAsmtMetric.updateMultiple();
}

]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2019-05-23 05:07:27&lt;/sys_created_on&gt;
        &lt;sys_id&gt;31e2bce1eb6811e98758251694724243&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;17&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;fix_remove_additional_info_questions&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;3baf2208138e4343807decb9a6de5340&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value=""&gt;3baf2208138e4343807decb9a6de5340&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_31e2bce1eb6811e98758251694724243&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2019-06-20 22:44:07&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:20:06</sys_created_on>
        <sys_id>20c2385d83b01210c6695855eeaad346</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>fix_remove_additional_info_questions</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_20c2385d83b01210c6695855eeaad346</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:20:06</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
