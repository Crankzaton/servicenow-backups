<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>153c95a353f3001076bcddeeff7b1202</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.BusinessCalendarIndexManager&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description/&gt;
        &lt;name&gt;BusinessCalendarIndexManager&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var BusinessCalendarIndexManager = Class.create();

BusinessCalendarIndexManager.prototype = {

	initialize: function() {
		this.CALENDAR_INDICES = 'calendar_indices';
		this.CALENDAR = 'calendar';
		this.MAX_INDEX_COUNT = 10;
		this.CALENDAR_FOR_INDEX_PREFIX = 'calendar_for_index';
		this.BUSINESS_CALENDAR_SPAN = 'business_calendar_span';
		this.CALENDAR = 'calendar';
		this.START = 'start';
		this.END = 'end';
		this.COUNTER = 'counter';
	},

	buildAllIndexes: function(calendarSysId) {
		var indices = new GlideRecord(this.CALENDAR_INDICES);
		indices.addQuery(this.CALENDAR, calendarSysId);
		indices.query();
		while (indices.next()) {
			for (var i = 0; i &lt; this.MAX_INDEX_COUNT; i++) {
				var indexFieldName = this.CALENDAR_FOR_INDEX_PREFIX + i;
				var containerSysId = indices.getValue(indexFieldName);
				if (containerSysId == null) {
					continue;
				}
				var containerSpans = new GlideRecord(this.BUSINESS_CALENDAR_SPAN);
				containerSpans.addQuery(this.CALENDAR, containerSysId);
				containerSpans.orderBy(this.START);
				containerSpans.query();
				while (containerSpans.next()) {
					var containerIndex = 0;
					var spans = new GlideRecord(this.BUSINESS_CALENDAR_SPAN);
					spans.addQuery(this.CALENDAR, calendarSysId);
					spans.addQuery(this.START, '&gt;=', containerSpans.getValue('start'));
					spans.addQuery(this.START, '&lt;', containerSpans.getValue('end'));
					spans.orderBy(this.START);
					spans.setWorkflow(false);
					spans.query();
					while (spans.next()) {
						var idxFieldName = 'index' + i;
						if (spans.getValue(idxFieldName) != containerIndex) {
							spans.setValue(idxFieldName, containerIndex);
							spans.update();
						}
						containerIndex++;
					}
				}
			}
		}
		this._setValueForCounter(calendarSysId);
	},

	_setValueForCounter: function(aCalendarSysId) {
		var countSetter = new GlideRecord(this.BUSINESS_CALENDAR_SPAN);
		countSetter.addQuery(this.CALENDAR, aCalendarSysId);
		countSetter.setWorkflow(false);
		countSetter.orderBy(this.START);
		countSetter.query();
		var counterValue = 0;
		while (countSetter.next()) {
			if (countSetter.getValue(this.COUNTER) != counterValue) {
				countSetter.setValue(this.COUNTER, counterValue);
				countSetter.update();
			}
			counterValue++;
		}
	},

	_wipeAllIndexes: function(aCalendarSysId) {
		var wipe = new GlideMultipleUpdate(this.BUSINESS_CALENDAR_SPAN);
		wipe.addQuery(this.CALENDAR, aCalendarSysId);
		wipe.setValue(this.COUNTER, null);
		for (var i = 0; i &lt; this.MAX_INDEX_COUNT; i++) {
			var indexFieldName = 'index' + i;
			wipe.setValue(indexFieldName, null);
		}
		wipe.execute();
	},

	type: 'BusinessCalendarIndexManager'	
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;maint&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2020-04-02 00:35:45&lt;/sys_created_on&gt;
        &lt;sys_id&gt;153c95a353f3001076bcddeeff7b1202&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;107&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;BusinessCalendarIndexManager&lt;/sys_name&gt;
        &lt;sys_package display_value="Business Calendars" source="com.glide.business_calendars"&gt;3a467ca03cb1311068bcf327dfe37f73&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_153c95a353f3001076bcddeeff7b1202&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2020-04-16 21:27:24&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:10:42</sys_created_on>
        <sys_id>039078d583b01210c6695855eeaad383</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>BusinessCalendarIndexManager</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_039078d583b01210c6695855eeaad383</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:10:42</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
