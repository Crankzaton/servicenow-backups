<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="x_938076_now_utils_now_utils_business_rules">
    <x_938076_now_utils_now_utils_business_rules action="INSERT_OR_UPDATE">
        <abort_action>false</abort_action>
        <access>package_private</access>
        <action_delete>false</action_delete>
        <action_insert>false</action_insert>
        <action_query>false</action_query>
        <action_update>true</action_update>
        <active>true</active>
        <add_message>false</add_message>
        <advanced>true</advanced>
        <change_fields>false</change_fields>
        <client_callable>false</client_callable>
        <collection/>
        <condition/>
        <description/>
        <execute_function>false</execute_function>
        <filter_condition/>
        <is_rest>false</is_rest>
        <message/>
        <name>Close skip previous tasks</name>
        <order>100</order>
        <priority>100</priority>
        <rest_method/>
        <rest_method_text/>
        <rest_service/>
        <rest_service_text/>
        <rest_variables/>
        <role_conditions/>
        <script><![CDATA[/** All tasks for the in-flight TOLs are created at once and these tasks should be closed in the order mentioned. 
 When a task with higher order than some other tasks is closed, This business rule will close skip the tasks whose order is less than the current closing task.
 This business rule will only run when there are more than 2 open/pending/work in progress tasks for the TOL. This ensures that the business rule will run only for in-flight TOLs as for any new TOL that is created, will have a workflow associated with it and thus creating one task at a time.
**/

closeSkipPreviousTasks();

function closeSkipPreviousTasks() {
    var taskCount = getOpenTaskCount();
    var firstOpenTaskGr = getFirstOpenTask();

    if (!gs.nil(firstOpenTaskGr)) {
        if (taskCount >= 2 && firstOpenTaskGr.getValue('order') < current.getValue('order')) {
            // Close skip the tasks whose order is less than the current
            closeBeforeTasks();
        }
    }

    function closeBeforeTasks() {
        var tolTaskGr = new GlideRecord('alm_transfer_order_line_task');
        tolTaskGr.addQuery('transfer_order_line', current.transfer_order_line);
        // state = 1 = Open, state = 2 = Work In Progress, state = -5 = Pending
        tolTaskGr.addQuery('state', 'IN', '-5,1,2');
        tolTaskGr.addQuery('order', '<', parseInt(current.order));
  tolTaskGr.orderBy('order');
        tolTaskGr.query();
        while (tolTaskGr.next()) {
            tolTaskGr.setValue('state', 7);
            tolTaskGr.update();
        }
  
    }

    function getFirstOpenTask() {
        var tolTaskGr = new GlideRecord('alm_transfer_order_line_task');
        tolTaskGr.addQuery('transfer_order_line', current.transfer_order_line);
        // state = 1 = Open, state = 2 = Work In Progress, state = -5 = Pending
        tolTaskGr.addQuery('state', 'IN', '-5,1,2');
        tolTaskGr.orderBy('order');
        tolTaskGr.setLimit(1);
        tolTaskGr.query();
        if (tolTaskGr.next()) {
            return tolTaskGr;
        }
        return null;
    }

    function getOpenTaskCount() {
        taskCount = 0;
        var taskGr = new GlideAggregate('alm_transfer_order_line_task');
        taskGr.addQuery('transfer_order_line', current.transfer_order_line);
        // state = 1 = Open, state = 2 = Work In Progress, state = -5 = Pending
        taskGr.addQuery('state', 'IN', '-5,1,2');
        taskGr.addAggregate('COUNT', 'order');
        taskGr.orderByAggregate('COUNT', 'order');
        taskGr.setGroup(false);
        taskGr.query();
        if (taskGr.next()) {
            taskCount = parseInt(taskGr.getAggregate('COUNT', 'order'));
        }
        return taskCount;
    }
}]]></script>
        <sys_class_name>x_938076_now_utils_now_utils_business_rules</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 07:52:30</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>907c605983701210c6695855eeaad3ff</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Close skip previous tasks</sys_name>
        <sys_overrides/>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>x_938076_now_utils_now_utils_business_rules_907c605983701210c6695855eeaad3ff</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 07:52:30</sys_updated_on>
        <template/>
        <when>before</when>
    </x_938076_now_utils_now_utils_business_rules>
    <sys_translated_text action="delete_multiple" query="documentkey=907c605983701210c6695855eeaad3ff"/>
</record_update>
