<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>7a3ffa53ff2102003434ffffffffffae</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;This fix script deactivates an old rest quota rule which exists only on fuji zbooted instances and replaces it with 4 separate rest quota rules for Table, Import Set, Aggregate and Attachment API&lt;/description&gt;
        &lt;name&gt;Fix REST API Quota Rules&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[fixRestQuotaRules();

function fixRestQuotaRules() {
	var active, order, max_duration, max_queries, max_db_time, max_stmt_time, max_rules, max_events, max_jobs, max_outbound_http_requests, max_outbound_http_time;
	var oldQuotaRuleSysid = '20c02b419f232100ef4afa7dc67fcf9e';

	var oldGr = new GlideRecord('sysrule_quota');
	
	if (oldGr.get(oldQuotaRuleSysid)) {
		active = oldGr.active;
		max_duration = oldGr.max_duration;
		max_queries = oldGr.max_queries;
		max_db_time = oldGr.max_db_time;
		max_stmt_time = oldGr.max_stmt_time;
		max_rules = oldGr.max_rules;
		max_events = oldGr.max_events;
		max_jobs = oldGr.max_jobs;
		max_outbound_http_requests = oldGr.max_outbound_http_requests;
		max_outbound_http_time = oldGr.max_outbound_http_time;
		order = oldGr.order;
		
		createRestQuotaRule('REST Import Set API','type=rest^urlMATCH_RGX.*/api/now(/v[0-9]+)?/import.*^EQ');
		createRestQuotaRule('REST Table API','type=rest^urlMATCH_RGX.*/api/now(/v[0-9]+)?/table.*^EQ');
		createRestQuotaRule('REST Aggregate API','type=rest^urlMATCH_RGX.*/api/now(/v[0-9]+)?/stats.*^EQ');
		createRestQuotaRule('REST Attachment API','type=rest^urlMATCH_RGX.*/api/now(/v[0-9]+)?/attachment.*^EQ');
    	
    	oldGr.active = false;	
		var description = '[DO NOT ACTIVATE THIS RULE - It has been replaced by 3 separate rules: REST Aggregate API request timeout, REST Import Set API request timeout, and REST Table API request timeout] - ' + oldGr.description;
		oldGr.description = description;
	  	oldGr.setWorkflow(false);
		oldGr.setUseEngines(false);
		oldGr.update();
	} 
	
	function createRestQuotaRule(api_name,condition){
		var name = api_name + ' request timeout';
		var description = 'This quota rule applies to all incoming ' + api_name + ' transactions. Any transaction exceeding the maxium duration set here will be cancelled.';
	
		var gr = new GlideRecord('sysrule_quota');
		gr.query('condition',condition);
		if(gr.next()){
			gs.log('quota rule already exist for: ' + api_name);
			return; //quota already exists
		}
		
		gr.initialize();
		gr.name = name;
		gr.description = description;
		gr.condition = condition;
		
		// copied from old rest quota rule 
		gr.active = active;
		gr.order = order;
		gr.max_duration = max_duration;
		gr.max_queries = max_queries;
		gr.max_db_time = max_db_time;
		gr.max_stmt_time = max_stmt_time;
		gr.max_rules = max_rules;
		gr.max_events = max_events;
		gr.max_jobs = max_jobs;
		gr.max_outbound_http_requests = max_outbound_http_requests;
		gr.max_outbound_http_time = max_outbound_http_time;
	  	gr.setWorkflow(false);
		gr.setUseEngines(false);
		gr.insert();
	}
}
]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2015-08-03 23:34:30&lt;/sys_created_on&gt;
        &lt;sys_id&gt;7a3ffa53ff2102003434ffffffffffae&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;14&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Fix REST API Quota Rules&lt;/sys_name&gt;
        &lt;sys_package display_value="REST API Provider" source="com.glide.rest"&gt;0273f8e03c31311068bcf327dfe37fbd&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_7a3ffa53ff2102003434ffffffffffae&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2015-08-04 16:48:08&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:22:06</sys_created_on>
        <sys_id>71337c9d83b01210c6695855eeaad35d</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Fix REST API Quota Rules</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_71337c9d83b01210c6695855eeaad35d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:22:06</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
