<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>89aff72beb590110cf2dcd016d522881</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.I18NChoiceTool&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;true&lt;/client_callable&gt;
        &lt;description/&gt;
        &lt;name&gt;I18NChoiceTool&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var I18NChoiceTool = Class.create();
I18NChoiceTool.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {

    _getAFreshChoice : function(name, element, value) {
        return {
            c_name: name + '',
            c_element: element + '',
            c_value: value + '',
            c_inactive: 'SKIP',

            setInactive : function(inactive) {
                this.c_inactive = !!inactive &amp;&amp; ['1', 'true', 1, true].indexOf(inactive.toLowerCase()) &gt; -1;
            }
        };
    },

    _getUniqueName : function(choice) {
        var fd = '__'; //forbidden delimiter
        return choice.getValue('name') + fd + choice.getValue("element") + fd + choice.getValue('value') + fd;
    },

    _updateInactiveField : function(c) {
        if (c.c_inactive === 'SKIP') 
            return;
        var choice = new GlideRecord('sys_choice');
        choice.addQuery('name', c.c_name);
        choice.addQuery('element', c.c_element);
        choice.addQuery('value', c.c_value);
        choice.setValue('inactive', c.c_inactive);
        choice.setSystem(true);

        choice.updateMultiple();
    },

    _shouldSkip: function(choice) {
        var sciptyLabel = "I18nUtils().getUserLanguage()";

        // let's keep away the fuzzy script choices surrounding languages choices
        if ((choice.getValue('label') + '').indexOf(sciptyLabel)  &gt; -1) {
            return true;
        }

        // let's also steer clear of messing with the preferred_language choices as this should never need to be corrected
        if ('sys_user' == choice.getValue('name') &amp;&amp; 'preferred_language' == choice.getValue('element')) {
            return true;
        }

        return false;
    },

    makeAllTheChoicesRight: function() {
        var trigger_name = 'I18N: Re-activate trs choices';
        var published_trigger_name = 'ASYNC: ' + trigger_name;

        var script = 'new global.I18NChoiceTool().findAndRepairChoices();';
        
        var trigger = new GlideRecord('sys_trigger');
		if (trigger.isValid()) {
			trigger.addQuery('name', published_trigger_name);
			trigger.query();

            if (!trigger.next()) {
				var when = new GlideDateTime();
				when.addSeconds(60 * 15); // 15 min
				
				GlideRunScriptJob.scheduleScript(script, trigger_name, when);
            }
        }


    },

    // Looks for clumps of choices we need to fix
    findAndRepairChoices: function() {
        var sciptyLabel = "avascript:'System (' + new I18nUtils().getUserLanguage() + ')'";

        var choicesToCleanUp = [];  // our clumps go here
        var choice = new GlideRecord('sys_choice');
        choice.orderBy('name');
        choice.orderBy('element');
        choice.orderBy('value');

        choice.query();
        var uniqueName = '';
        var currentChoice = this._getAFreshChoice('', '', '');

        var canSkip = true;
        var lastInactive;

        while(choice.next()) {
            // At this very moment we've moved on to a new choice
            if (uniqueName != (this._getUniqueName(choice) + '')) {
                if (currentChoice.c_inactive != 'SKIP' &amp;&amp; !canSkip) {
                    choicesToCleanUp.push(currentChoice);
                }

                currentChoice = this._getAFreshChoice(choice.getValue('name'), choice.getValue('element'), choice.getValue('value'));
                uniqueName = this._getUniqueName(choice);
                lastInactive = choice.getValue('inactive') + '';
                canSkip = true;
            }

            // We only care if the choices are not in sync;
            var currentValueOfInactive = choice.getValue('inactive') + '';
            if (canSkip === true &amp;&amp; currentValueOfInactive != lastInactive) {
                canSkip = false;
            }

            if ('en' === choice.getValue('language') + '') {
                if (!this._shouldSkip(choice)) {
                    currentChoice.setInactive(currentValueOfInactive + '');
                }
            }
        }

        // Process the clumps
        for (var i = 0; i &lt; choicesToCleanUp.length; i++) {
            this._updateInactiveField(choicesToCleanUp[i]);
        }

        return JSON.stringify(choicesToCleanUp);
    },

    type: 'I18NChoiceTool'
});]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2022-02-02 14:51:41&lt;/sys_created_on&gt;
        &lt;sys_id&gt;89aff72beb590110cf2dcd016d522881&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;46&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;I18NChoiceTool&lt;/sys_name&gt;
        &lt;sys_package display_value="Core i18n" source="com.glide.i18n.core"&gt;e3f374283c31311068bcf327dfe37f61&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_89aff72beb590110cf2dcd016d522881&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2022-09-28 11:07:37&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:45:00</sys_created_on>
        <sys_id>5d78bc1183341210c6695855eeaad336</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>I18NChoiceTool</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_5d78bc1183341210c6695855eeaad336</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:45:00</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
