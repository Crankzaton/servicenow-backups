<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>405d2e23c34330103695e0dd9740ddd1</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;true&lt;/before&gt;
        &lt;description&gt;It will update the write acl script for pa_score_notes for customers who zbooted on quebec onwards.
Customers that upgraded from before quebec will not get the write ACL updated on upgrade.

The update will be removing the condition that allows anyone to update a comment without user role specified.
Basically we need to remove this condition from the script: "!current.user ||"

Write acl from quebec onwards that needs an update must meet the following requirement:
1- The ACL was not customized
2- The ACL script has the following 3 lines:
 2.1 - "answer = new SNC.PADomainUtils().isWriteable("pa_score_notes", current.sys_id);"
 2.2 - "if (!gs.hasRole('pa_admin') &amp;amp;&amp;amp; !gs.hasRole('pa_power_user') &amp;amp;&amp;amp; !gs.hasRole('pa_viewer') &amp;amp;&amp;amp; !gs.hasRole('pa_contributor'))"
 2.3- "answer = answer &amp;amp;&amp;amp; (!current.user || gs.getUser().getID() == current.user);"

&lt;/description&gt;
        &lt;name&gt;Update pa_scores write acl script&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[UpdateWriteACL();

function UpdateWriteACL() {
    if (pm.isZboot())
        return;

    var grCustomerUpdate = new GlideRecord('sys_update_xml');
    if (grCustomerUpdate.get('name', 'sys_security_acl_8663b798bf201100b96dac808c073999')) {
        gs.warn('Write ACL for pa_score_notes with sys_id 8663b798bf201100b96dac808c073999 was not updated on upgrade since it was already customised.');
    } else {
        var gr = new GlideRecord('sys_security_acl');
        gr.addEncodedQuery('sys_id=8663b798bf201100b96dac808c073999^scriptLIKEanswer = new SNC.PADomainUtils().isWriteable("pa_score_notes", current.sys_id);^scriptLIKEif (!gs.hasRole(\'pa_admin\') &amp;&amp; !gs.hasRole(\'pa_power_user\') &amp;&amp; !gs.hasRole(\'pa_viewer\') &amp;&amp; !gs.hasRole(\'pa_contributor\'))^scriptLIKEanswer = answer &amp;&amp; (!current.user || gs.getUser().getID() == current.user);');
        gr.query();
        if (!gr.next()) {
            gs.warn('Write ACL for pa_score_notes with sys_id 8663b798bf201100b96dac808c073999 and relevant script was not found in DB. no further action is required.');
        } else {
            var scriptText = 'answer = new SNC.PADomainUtils().isWriteable("pa_score_notes", current.sys_id);' + '\n';
            scriptText += 'if (!gs.hasRole(\'pa_admin\') &amp;&amp; !gs.hasRole(\'pa_power_user\') &amp;&amp; !gs.hasRole(\'pa_viewer\') &amp;&amp; !gs.hasRole(\'pa_contributor\'))' + '\n';
            scriptText += '\tanswer = answer &amp;&amp; (gs.getUser().getID() == current.user);';
            gr.setValue('script', scriptText);
            gr.update();
            gs.info('The script for the Write ACL for pa_score_notes with sys_id 8663b798bf201100b96dac808c073999 was updated successfuly');
        }
    }
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2021-10-13 13:03:22&lt;/sys_created_on&gt;
        &lt;sys_id&gt;405d2e23c34330103695e0dd9740ddd1&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;4&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Update pa_scores write acl script&lt;/sys_name&gt;
        &lt;sys_package display_value="Performance Analytics" source="com.snc.pa"&gt;4069fc643cf1311068bcf327dfe37fe4&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_405d2e23c34330103695e0dd9740ddd1&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-10-13 13:28:42&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:20:34</sys_created_on>
        <sys_id>6bd23c5d83b01210c6695855eeaad3f0</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Update pa_scores write acl script</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_6bd23c5d83b01210c6695855eeaad3f0</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:20:34</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
