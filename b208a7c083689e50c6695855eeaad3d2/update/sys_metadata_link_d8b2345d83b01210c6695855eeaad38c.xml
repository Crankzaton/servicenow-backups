<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>2901753d458d7410f877982bc07cd6aa</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;This script is to update search configurations on Now Mobile to get search results from content associated to taxonomy.&lt;/description&gt;
        &lt;name&gt;Enable Taxonomy For Mobile&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[/**
 * This script makes 5 changes.
 * 1. Removes 'Category is not empty' condition from AIS search source filter for catalogs
 * 2. Replaces the mapping betwen 'Services' Zing search source and 'NowMobile App Search Configurations' with a mapping between 'Services' Zing search source present in Now Mobile scope and 'NowMobile App Search Configurations'.
 * 3. Replaces the mapping betwen 'Articles' Zing search source and 'NowMobile App Search Configurations' with a mapping between 'Articles' Zing search source present in Now Mobile scope and 'NowMobile App Search Configurations'.
 * 4. Replace the 'category' field from card element attribute for Search Result Service Catalog with 'taxonomy_topic'.
 * 5. Replace the 'kb_category' field from card element attribute for Knowledge AIS search result with 'taxonomy_topic'.
 **/

var runManually = false; // Update this to true to run manually (forced updation even on customised records)

var EMPLOYEE_TAXONOMY = '1f5d5a40c3203010069aec4b7d40dd93';
var MESP = '26f2fffb77322300454792718a1061e5';
var M2M_NOWMOBILE_SEARCHCONFIG_SERVICES = '7351749673032300c342d5fdbdf6a750';
var ZING_SEARCH_SOURCE_TAXONOMY_SERVICES = '336ab1c5c7313010fedf0bcbe2c2601f';
var M2M_NOWMOBILE_SEARCHCONFIG_ARTICLES = '0a51749673032300c342d5fdbdf6a75a';
var ZING_SEARCH_SOURCE_TAXONOMY_ARTICLES = '2b6cc681c7713010fedf0bcbe2c2606c';
var CATALOG_CARD_ELEMENT_ATTRIBUTE = 'c46814af53231010f1c8ddeeff7b1267';
var KNOWLEDGE_CARD_ELEMENT_ATTRIBUTE = 'd4488f0474b71010f877de4112351625';

var taxonomySysPropRecord = new GlideRecord('sys_properties');
taxonomySysPropRecord.addQuery('name','sn_me.taxonomy_enabled');
taxonomySysPropRecord.setLimit(1);
taxonomySysPropRecord.query();
var isTaxonomyEnabled = (taxonomySysPropRecord.next() &amp;&amp; taxonomySysPropRecord.getValue('value') === 'true') ? true : false;

if (isTaxonomyEnabled) {
    gs.info(gs.getMessage("Enabling taxonomy portal and search configurations for mobile"));
    new sn_scmobile.MobileCatalogUtil().removeCategoryFilterCondition(runManually);
    this.updateCatlaogZingSearch();
    this.updateKnowledgeZingSearch();
    this.updateCatalogCardElementAttribute();
    this.updateKnowledgeCardElementAttribute();
} else
    gs.info(gs.getMessage("Taxonomy for mobile is not enabled, please run the fix script manually after setting the property 'sn_me.taxonomy_enabled' to true"));

function updateCatlaogZingSearch() {
    var gr = new GlideRecord('m2m_search_context_config_search_source');
    if (!gr.canWrite()) {
        gs.info(gs.getMessage("User {0} does not have write access to 'm2m_search_context_config_search_source' table.", [gs.getUserID()]));
        return;
    }
    if (gr.get(M2M_NOWMOBILE_SEARCHCONFIG_SERVICES)) {
        if (!this.isCustomised('m2m_search_context_config_search_source_' + M2M_NOWMOBILE_SEARCHCONFIG_SERVICES) || runManually) {
            gr.setValue('source', ZING_SEARCH_SOURCE_TAXONOMY_SERVICES);
            gr.update();
        }
    } else
        gs.info(gs.getMessage("Enable Taxonomy for Mobile: Mapping between 'NowMobile App Search Configurations' and 'Services' search source not found"));
}

function updateKnowledgeZingSearch() {
    var gr = new GlideRecord('m2m_search_context_config_search_source');
    if (!gr.canWrite())
        return;
    if (gr.get(M2M_NOWMOBILE_SEARCHCONFIG_ARTICLES)) {
        if (!this.isCustomised('m2m_search_context_config_search_source_' + M2M_NOWMOBILE_SEARCHCONFIG_ARTICLES) || runManually) {
            gr.setValue('source', ZING_SEARCH_SOURCE_TAXONOMY_ARTICLES);
            gr.update();
        }
    } else
        gs.info(gs.getMessage("Enable Taxonomy for Mobile: Mapping between 'NowMobile App Search Configurations' and 'Articles' search source not found"));
}

function updateCatalogCardElementAttribute() {
    var gr = new GlideRecord('sys_sg_view_config_element_attribute');
    if (!gr.canWrite())
        return;
    if (gr.get(CATALOG_CARD_ELEMENT_ATTRIBUTE)) {
        if (!this.isCustomised('sys_sg_view_config_element_attribute_' + CATALOG_CARD_ELEMENT_ATTRIBUTE) || runManually) {
            gr.setValue('value', 'taxonomy_topic');
            gr.update();
        }
    } else
        gs.info(gs.getMessage("Enable Taxonomy for Mobile: Card Element attribute for Catalog Search Item Category not found"));
}

function updateKnowledgeCardElementAttribute() {
    var gr = new GlideRecord('sys_sg_view_config_element_attribute');
    if (!gr.canWrite())
        return;
    if (gr.get(KNOWLEDGE_CARD_ELEMENT_ATTRIBUTE)) {
        if (!this.isCustomised('sys_sg_view_config_element_attribute_' + KNOWLEDGE_CARD_ELEMENT_ATTRIBUTE) || runManually) {
            gr.setValue('value', 'taxonomy_topic');
            gr.update();
        }
    } else
        gs.info(gs.getMessage("Enable Taxonomy for Mobile: Card Element attribute for Knowledge AIS search result category not found"));
}

function isCustomised(name) {
    var updateGr = new GlideRecord('sys_update_xml');
    updateGr.addQuery('name', name);
    updateGr.setLimit(1);
    updateGr.query();
    return updateGr.hasNext();
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;maint&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2021-06-30 11:21:13&lt;/sys_created_on&gt;
        &lt;sys_id&gt;2901753d458d7410f877982bc07cd6aa&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;3&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Enable Taxonomy For Mobile&lt;/sys_name&gt;
        &lt;sys_package display_value="Now Mobile" source="sn_me"&gt;5cfbdaac77eb2300454792718a106157&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Now Mobile"&gt;5cfbdaac77eb2300454792718a106157&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_2901753d458d7410f877982bc07cd6aa&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-07-30 11:08:46&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;true&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:19:48</sys_created_on>
        <sys_id>d8b2345d83b01210c6695855eeaad38c</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Enable Taxonomy For Mobile</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_d8b2345d83b01210c6695855eeaad38c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:19:48</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
