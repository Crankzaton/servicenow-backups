<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>11d170917f0312005f58108c3ffa9118</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.NotificationUnsubscribe&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;true&lt;/client_callable&gt;
        &lt;description/&gt;
        &lt;name&gt;NotificationUnsubscribe&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var NotificationUnsubscribe = Class.create();
NotificationUnsubscribe.prototype = {

	unsubscribe: function(notification, notificationType) {
		// Only attempt to unsubscribe if the notificaiton exists
		var result = this._validateNotification(notification);
		if (result.notificationExists !== 'true') {
			gs.warn('Attempt to unsubscribe user ' + gs.getUserName() + ' failed ' +
					'because notification (' + notification + ') does not exist', 'NotificationUnsubscribe');
			return {
				'notificationName' : '',
				'header' : gs.getMessage('Unsubscribe Failed'),
				'message' : gs.getMessage('Cannot unsubscribe because the notification was not found on this system.')
			};
		}
		
		var userId = gs.getUserID();
		
		// Unsubscribe from subscriptions
		var subscriptionCount = this._sysNotifSubscriptionUnsubscribe(notification, notificationType, userId);
		
		// Mandatory notifications can't be disabled from preferences
		if (result.mandatory === 'true') {
			return {
				'notificationName' : result.notificationName,
				'header' : gs.getMessage('Notification marked Mandatory'),
				'message' : gs.getMessage('We unsubscribed you from the notification {0}, however as it is mandatory you may still receive it.', result.notificationName)
			};
		}
		
		// Unsubscribe from cmn_notif_devices
		var messageCount = this._cmnNotifMessageUnsubscribe(notificationType, userId, notification);

		if (subscriptionCount &lt; 1 &amp;&amp; messageCount &lt; 1) {
			return {
				'notificationName' : result.notificationName,
				'header' : gs.getMessage('Unsubscribe Failed'),				
				'message' : gs.getMessage('There is no record of you receiving the {0} notification.', result.notificationName)
			};
		}
		
		return {
			'notificationName' : result.notificationName,
			'header' : gs.getMessage('Unsubscribe Successful'),
			'message' : gs.getMessage('You have unsubscribed from the notification {0}.', result.notificationName)
		};
	},
	
	_validateNotification: function(notification) {
		var notificationGR = new GlideRecord('sysevent_email_action');
		if (!notificationGR.get(notification)) {
			return {
				notificationExists : 'false'
			};
		}

		if (notificationGR.mandatory || notificationGR.force_delivery) {
			return {
				notificationExists : 'true',
				mandatory : 'true',
				notificationName : notificationGR.getValue('name')
			};
		}
		
		return {
			notificationExists : 'true',
			mandatory : 'false',
			notificationName : notificationGR.getValue('name')
		};
	},
	
	_sysNotifSubscriptionUnsubscribe: function(notification, notificationType, userId) {
		var subscriptionGR = new GlideRecord('sys_notif_subscription');
		subscriptionGR.addQuery('notification', notification);
		subscriptionGR.addQuery('user', userId);
		subscriptionGR.query();

		var emailDevicesGR = new GlideRecord('cmn_notif_device');
		emailDevicesGR.addQuery('user', userId);
		if (notificationType == 'email')
			emailDevicesGR.addQuery('type', 'Email');
		emailDevicesGR.query();

		// Save off the sys_ids of all the devices that need to be removed from the subscription
		var emailDevices = [];
		while (emailDevicesGR.next()) {
			emailDevices.push(emailDevicesGR.getUniqueValue());
		}

		// Remove the devices from all appropriate subscriptions
		var totalRowsAffected = 0;
		while (subscriptionGR.next()) {
			var devices = subscriptionGR.getValue('devices');
			if (devices) {
				devicesWithEmailRemoved = this._removeMatchingValues(emailDevices, devices.split(','));
				if (devices.length != devicesWithEmailRemoved.length) {
					totalRowsAffected += 1;
				}
				subscriptionGR.setValue('devices', devicesWithEmailRemoved);
				subscriptionGR.update();
			}
		}
		
		return totalRowsAffected;
	},
	
	_cmnNotifMessageUnsubscribe: function(notificationType, userId, notification) {
		var UNSUBSCRIBE_FILTER_SYS_ID ='c1bfa4040a0a0b8b001eeb0f3f5ee961';
		var cmnNotifMessageGR = new GlideRecord('cmn_notif_message');
		var deviceList = this._getDeviceList(notificationType, userId);
		cmnNotifMessageGR.addQuery('device', 'IN', deviceList);
		cmnNotifMessageGR.addQuery('notification', notification);
		cmnNotifMessageGR.addQuery('user', userId);
		cmnNotifMessageGR.query();
		var rowCount = cmnNotifMessageGR.getRowCount(); 
		cmnNotifMessageGR.setValue('notification_filter', UNSUBSCRIBE_FILTER_SYS_ID);
		cmnNotifMessageGR.updateMultiple();
		return rowCount;
	},

	_removeMatchingValues: function(valuesToRemove, values) {
		var arrayUtil = new ArrayUtil();
		return arrayUtil.diff(values, valuesToRemove);
	},
	
	_getDeviceList: function(deviceTypes, userId) {
		var deviceGR = new GlideRecord('cmn_notif_device');
		deviceGR.addQuery('user', userId);
		if (deviceTypes === 'email')
			deviceGR.addQuery('type', 'Email');
		deviceGR.query();
		
		var result = [];
		while (deviceGR.next()) {
			result.push(deviceGR.getValue('sys_id'));
		}

		return result;
	},
	
    type: 'NotificationUnsubscribe'
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2016-04-26 17:45:52&lt;/sys_created_on&gt;
        &lt;sys_id&gt;11d170917f0312005f58108c3ffa9118&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;91&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;NotificationUnsubscribe&lt;/sys_name&gt;
        &lt;sys_package display_value="Subscription Based Notifications" source="com.glide.notification"&gt;8f83b4243c31311068bcf327dfe37f87&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_11d170917f0312005f58108c3ffa9118&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2016-06-03 16:27:00&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:10:24</sys_created_on>
        <sys_id>9280b0d583b01210c6695855eeaad33f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>NotificationUnsubscribe</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_9280b0d583b01210c6695855eeaad33f</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:10:24</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
