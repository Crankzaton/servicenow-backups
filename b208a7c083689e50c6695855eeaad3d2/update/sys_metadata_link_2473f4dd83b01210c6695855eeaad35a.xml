<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>9c8b7ac54f4fd510c086fe29f7c71416</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;The main purpose of this script is to revert updates to use config view, if there are any customisation present on legacy cards.&lt;/description&gt;
        &lt;name&gt;Revert Customised Legacy Cards In FSM&lt;/name&gt;
        &lt;record_for_rollback&gt;true&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[var output = {};
output.msg = "";
addMsg("Start process FSM Mobile upgrade fix to avoid overriding customized records at " + getCurrentTimestamp());

output.customizedRecordStrList = [];

//initializing gcd
var cdd =new global.CollisionDetectorDelegate();

var legacy_card_table = "sys_sg_item_view";
var ui_style_table = "sys_sg_ui_style";

var card_list = [
    {
        "card_name": "Asset Basic 02",
        "legacy_card_id":"c7c0a501774301104fcd79207b5a99b0",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "4a2ceb7253b0330097a2ddeeff7b1263",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","c7c0a501774301104fcd79207b5a99b0"]
    },
    {
        "card_name": "Part Requirement Basic",
        "legacy_card_id":"e6f7d019e781230003cd6188d2f6a9bb",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "884cef7253b0330097a2ddeeff7b1209",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","e6f7d019e781230003cd6188d2f6a9bb"]
    },
    {
        "card_name": "Asset Main - Remove Part",
        "legacy_card_id":"cb40b80fe7e1230066156188d2f6a93a",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "1dcb1f82b3052300a0d56ad4c6a8dc92",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","cb40b80fe7e1230066156188d2f6a93a"]
    },
    {
        "card_name": "Asset Item View for Available Part",
        "legacy_card_id":"0aac94db5b04d010400f53643381c771",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "9f23a8d75b08d010400f53643381c7fa",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","0aac94db5b04d010400f53643381c771"]
    },
    {
        "card_name": "Asset Item View for Reserved Part",
        "legacy_card_id":"779c1c9f5b04d010400f53643381c755",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "5713a8d75b08d010400f53643381c7f0",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","779c1c9f5b04d010400f53643381c755"]
    },
    {
        "card_name": "Asset Look-up item",
        "legacy_card_id":"e0e1a50a736323008c5127cb1bf6a724",//
        "source_table": "sys_sg_master_item",
        "source_sys_id": "f0e1e10a736323008c5127cb1bf6a77e",//
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","e0e1a50a736323008c5127cb1bf6a724"]
    },
    {
        "card_name": "Asset Look-up item",
        "legacy_card_id":"e0e1a50a736323008c5127cb1bf6a724",//
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "0a3caf7253b0330097a2ddeeff7b1212",//
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","e0e1a50a736323008c5127cb1bf6a724"]
    },
     {
        "card_name": "Asset Look-up item",
        "legacy_card_id":"e0e1a50a736323008c5127cb1bf6a724",//
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "b98e1929b7041010fad4fc54ce11a9db",//
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","e0e1a50a736323008c5127cb1bf6a724"]
    },
    {
        "card_name": "Asset Basic",
        "legacy_card_id":"54a21bcde701230003cd6188d2f6a9dd",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "896ae6d1c76733004c1bf9f91dc26060",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","54a21bcde701230003cd6188d2f6a9dd"]
    },
    {
        "card_name": "Asset Basic",
        "legacy_card_id":"54a21bcde701230003cd6188d2f6a9dd",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "462ceb7253b0330097a2ddeeff7b127a",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","54a21bcde701230003cd6188d2f6a9dd"]
    },
    {
        "card_name": "Asset Basic",
        "legacy_card_id":"54a21bcde701230003cd6188d2f6a9dd",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "044caf7253b0330097a2ddeeff7b12e6",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","54a21bcde701230003cd6188d2f6a9dd"]
    },
    {
        "card_name": "Asset Basic",
        "legacy_card_id":"54a21bcde701230003cd6188d2f6a9dd",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "9d79366dc7a733004c1bf9f91dc260d9",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","54a21bcde701230003cd6188d2f6a9dd"]
    },
    {
        "card_name": "Asset Item View",
        "legacy_card_id":"456aee91c76733004c1bf9f91dc2604f",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "c96ae6d1c76733004c1bf9f91dc26072",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","456aee91c76733004c1bf9f91dc2604f"]
    },
    {
        "card_name": "Asset Item View",
        "legacy_card_id":"456aee91c76733004c1bf9f91dc2604f",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "9579366dc7a733004c1bf9f91dc260f7",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","456aee91c76733004c1bf9f91dc2604f"]
    },
    {
        "card_name": "My Inventory Group By",
        "legacy_card_id":"25accfc9e701230003cd6188d2f6a905",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "b7fa8629c76733004c1bf9f91dc260de",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","25accfc9e701230003cd6188d2f6a905"]
    },
    {
        "card_name": "My Inventory Group By",
        "legacy_card_id":"25accfc9e701230003cd6188d2f6a905",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "7abc72edc7a733004c1bf9f91dc2605d",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","25accfc9e701230003cd6188d2f6a905"]
    },
	{
        "card_name": "Part Transfers Item View",
        "legacy_card_id":"3645e07453e333000b60ddeeff7b1293",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "0745647453e333000b60ddeeff7b121d",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","3645e07453e333000b60ddeeff7b1293"]
    },
    {
        "card_name": "Part Transfers Item View",
        "legacy_card_id":"3645e07453e333000b60ddeeff7b1293",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "ea07457c53e333000b60ddeeff7b12e4",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","3645e07453e333000b60ddeeff7b1293"]
    },
    {
        "card_name": "Part Transfers Header Item View",
        "legacy_card_id":"b645647453e333000b60ddeeff7b1212",
        "source_table": "sys_sg_form_screen",
        "source_sys_id": "3a45647453e333000b60ddeeff7b1214",
        "source_fields": ["segments_height","segments_min_width","use_view_config","view_config","item_view"],
        "source_values": ["","","false","","b645647453e333000b60ddeeff7b1212"]
    },
    {
        "card_name": "Part Requirement Main",
        "legacy_card_id": "4666d8d5e781230003cd6188d2f6a941",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "258197c2e7c1230003cd6188d2f6a9ff",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","4666d8d5e781230003cd6188d2f6a941"]
    },
    {
        "card_name": "Asset Look-up detail item view",
        "legacy_card_id":"b4e1650a736323008c5127cb1bf6a7fd",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "163ab4490fa300105cbf3694ba767eb6",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","b4e1650a736323008c5127cb1bf6a7fd"]
    },
    {
        "card_name": "Asset Usage Main",
        "legacy_card_id":"cd55aad9e781230003cd6188d2f6a9db",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "a683e2d9e781230003cd6188d2f6a9f2",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","cd55aad9e781230003cd6188d2f6a9db"]
    },
    {
        "card_name": "Available Parts Card New",
        "legacy_card_id":"9a2ceb7253b0330097a2ddeeff7b1281",
        "source_table": "sys_sg_master_item",
        "source_sys_id": "122ceb7253b0330097a2ddeeff7b1284",
        "source_fields": ["use_view_config","view_config","item_view"],
        "source_values": ["false","","9a2ceb7253b0330097a2ddeeff7b1281"]
    },

]

mainProcess();

function mainProcess(){

    if (global.FSMUtil.isZboot())
        return;

    if (!cdd.isGcdLoaded()) {
        addMsg("Error in initiating GlideCollisionDetector.");
        addMsg("Ended.");
        printMsg();
        return;
    }

    addMsg("Process view cards...");
    for (var i = 0; i &lt; card_list.length; i++) {
        var card = card_list[i];

        //check for legacy card
        var oldItemViewGr = new GlideRecord(legacy_card_table);
        if (!oldItemViewGr.get(card["legacy_card_id"])) {
            addMsg("The legacy card is invalid: " + legacy_card_table + '|' + card["legacy_card_id"]);
            continue;
        }

        //if legacy card is customized then proceed
        addMsg("&gt;" + getRecInfoStr(oldItemViewGr));
        if (isCustomized(oldItemViewGr) || isUIStylesCustomized(oldItemViewGr)) {
            output.customizedRecordStrList.push(oldItemViewGr.sys_update_name+"");
            //check for source record and if it is not customized then proceed
            var sourceGr = new GlideRecord(card["source_table"]);
            if (!sourceGr.get(card["source_sys_id"])) {
                addMsg("The source record is invalid: " + card["source_table"] + '|' + card["source_sys_id"]);
                continue;
            }
            addMsg("Source record details: " + getRecInfoStr(sourceGr));
            if (!isCustomized(sourceGr)) {
                addMsg("Reverting the view config change on " + sourceGr.sys_update_name);
                var hasChanges = false;
                for (var j = 0; j &lt; card["source_fields"].length; j++) {
                    sourceGr.setValue(card["source_fields"][j], card["source_values"][j]);
                    hasChanges = true;
                }
    
                if (hasChanges) {
                    sourceGr.update();
                }
            }
        }
    }
    addMsg("!All Cards processing completed");
    printStringsFromList(output.customizedRecordStrList, "customized records");
    addMsg("End process FSM Mobile upgrade fix to avoid overriding customized records at " + getCurrentTimestamp());
    printMsg();
}

// utils
function addMsg(msg) { output.msg += msg + "\n"; }
function printMsg(msg) {
    gs.info("FSM Mobile upgrade fix output at " + getCurrentTimestamp()+"\n" + (msg ? msg : output.msg));
    output.msg = "";
}
function getRecInfoStr(gr) {
    var res = [
        gr.sys_class_name,
        gr.sys_id,
        gr.sys_created_by,
        gr.sys_updated_by,
        gr.name
    ]
    return res.join("|");
}
function getCurrentTimestamp() {
    var d = new GlideDateTime();
    var ms = d.getNumericValue();
    return (d+'('+ms+')');
}
function printStringsFromList(arry, recordName) {
    addMsg("Total number of " + recordName + ": " + arry.length)
    for (var i=0; i&lt;arry.length; i++) {
        addMsg(arry[i]);
    }
}
function isCustomized(gr) {
    var updateName = gr.sys_update_name+"";
    if (cdd.containsKey(updateName)) {
        addMsg("!Detected customization in " + updateName);
        return true;
    }
    addMsg("!No customization detected in " + updateName);
    return false;
}
function isUIStylesCustomized(gr) {
    var styles = gr.getValue("ui_styles");
    if(styles){
        styles = styles.split(",");
        for (var i=0; i&lt;styles.length; i++){
            var uiStyleRecordGr = new GlideRecord(ui_style_table);
            if (!uiStyleRecordGr.get(styles[i])) {
                addMsg("The UI style is invalid: " + ui_style_table + '|' + styles[i]);
                continue;
            }
            if (isCustomized(uiStyleRecordGr)){
                return true;
            }
        }
    }
    return false;
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2022-11-07 11:16:25&lt;/sys_created_on&gt;
        &lt;sys_id&gt;9c8b7ac54f4fd510c086fe29f7c71416&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;Revert Customised Legacy Cards In FSM&lt;/sys_name&gt;
        &lt;sys_package display_value="Field Service Mobile" source="sn_fsm_mobile"&gt;5d66b0fbe770230003cd6188d2f6a976&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Field Service Mobile"&gt;5d66b0fbe770230003cd6188d2f6a976&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_9c8b7ac54f4fd510c086fe29f7c71416&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2022-11-07 11:16:25&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:23:06</sys_created_on>
        <sys_id>2473f4dd83b01210c6695855eeaad35a</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Revert Customised Legacy Cards In FSM</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_2473f4dd83b01210c6695855eeaad35a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:23:06</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
