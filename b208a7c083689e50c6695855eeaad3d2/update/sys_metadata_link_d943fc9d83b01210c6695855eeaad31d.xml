<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>822934e6eb43201066c7c03f1a522817</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_fix"&gt;
    &lt;sys_script_fix action="INSERT_OR_UPDATE"&gt;
        &lt;before&gt;false&lt;/before&gt;
        &lt;description&gt;This fix script is for migrating va actions from Quebec to Rome.&lt;/description&gt;
        &lt;name&gt;VA Actions migration from Q to R&lt;/name&gt;
        &lt;record_for_rollback&gt;false&lt;/record_for_rollback&gt;
        &lt;script&gt;&lt;![CDATA[var customerNotifications = [];
var modifiedNotifications = [];
var oobNotifications = {};

var sysUpdateGr = new GlideRecord("sys_update_xml");
sysUpdateGr.addEncodedQuery("nameSTARTSWITHsys_notification_^type=Notification");
sysUpdateGr.query();
while(sysUpdateGr.next()) {
    modifiedNotifications.push(sysUpdateGr.getValue("name")+"");
}

var upgradeHistoryGr = new GlideRecord("sys_upgrade_history_log");
upgradeHistoryGr.addEncodedQuery("type=Notification");
upgradeHistoryGr.query();
while(upgradeHistoryGr.next()) {
    oobNotifications[upgradeHistoryGr.getValue("file_name")+""] = "";
}

modifiedNotifications.forEach(function(notif) {
    if(!oobNotifications.hasOwnProperty(notif)) {
       customerNotifications.push(notif.substring("sys_notification_".length));
    }
});

if(customerNotifications.length &gt; 0) {
	gs.info("found customer notifications on the instance: "+ customerNotifications);
    var gr = new GlideRecord("sys_notification");
    gr.addQuery('sys_id', 'IN', customerNotifications.join());
    gr.query();
    while(gr.next()) {
		try {
			var hasMessagingContent = false;
			var hasChatContent = false;
			var messagingContentSysId = "";
			var chatContentSysId = "";
			var notificationId = gr.getUniqueValue();
			var vaContentGr = new GlideRecord("sys_notification_va_content");
			vaContentGr.addQuery("notification", notificationId);
			vaContentGr.query();
			if(!vaContentGr.hasNext()) {
				continue;
			}
			while(vaContentGr.next()) {
				if("sys_notification_va_content" == vaContentGr.getValue("sys_class_name")) {
					hasChatContent = true;
					chatContentSysId = vaContentGr.getUniqueValue();
				} else {
					hasMessagingContent = true;
					messagingContentSysId = vaContentGr.getUniqueValue();
				}
			}
	
			if(hasChatContent || hasMessagingContent) {
				var vaActionGr = new GlideRecord("sys_notification_va_action");
				vaActionGr.addQuery("notification", notificationId);
				vaActionGr.addActiveQuery();
				vaActionGr.query();
				if(vaActionGr.hasNext()) {
					var actionContentGr = new GlideRecord("sys_notification_actionable_content");
					actionContentGr.addQuery("notification", notificationId);
					actionContentGr.query();
					if(actionContentGr.hasNext()) {
						gs.info("action content already exists for notification: "+notificationId);
						continue;
					} else {
						//convert to new content format
						var actions = "";
						var first = true;
						while(vaActionGr.next()) {
							if(!first) {
								actions = actions + ",";
							}
							actions = actions + vaActionGr.getUniqueValue();
							first = false;
						}
	
						if(hasChatContent) {
							//chat content record
							var chatActionContentGR = new GlideRecord("sys_notification_actionable_content");
							chatActionContentGR.setValue("notification",notificationId);
							chatActionContentGR.setValue("name","Chat Content Actions");
							chatActionContentGR.setValue("actions", actions);
							chatActionContentGR.setValue("active", true);
							chatActionContentGR.setValue("content", chatContentSysId);
							chatActionContentGR.setValue("sys_scope", gr.getValue("sys_scope"));
							chatActionContentGR.insert();
							gs.info("created actionable content for chat content for notification: "+notificationId);
						}
	
						if(hasMessagingContent) {
							//messaging content record
							var messagingActionContentGR = new GlideRecord("sys_notification_actionable_content");
							messagingActionContentGR.setValue("notification",notificationId);
							messagingActionContentGR.setValue("name","Messaging Content Actions");
							messagingActionContentGR.setValue("actions", actions);
							messagingActionContentGR.setValue("active", true);
							messagingActionContentGR.setValue("content", messagingContentSysId);
							messagingActionContentGR.setValue("sys_scope", gr.getValue("sys_scope"));
							messagingActionContentGR.insert();
							gs.info("created actionable content for messaging content for notification: "+notificationId);
						}
	
					}
				}
			}
		} catch(error) {
			gs.error("Exception while migrating notification actions for :"+ gr.getUniqueValue()+ " with error: " + error.message);
		}
	}
} else {
	gs.info("There are no customer defined notifications to migrate");
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_fix&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2021-03-25 05:08:41&lt;/sys_created_on&gt;
        &lt;sys_id&gt;822934e6eb43201066c7c03f1a522817&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;2&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;VA Actions migration from Q to R&lt;/sys_name&gt;
        &lt;sys_package display_value=""&gt;e3c239e293400210b31a30dcebba1088&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_fix_822934e6eb43201066c7c03f1a522817&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-03-29 04:42:06&lt;/sys_updated_on&gt;
        &lt;unloadable&gt;false&lt;/unloadable&gt;
    &lt;/sys_script_fix&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:22:19</sys_created_on>
        <sys_id>d943fc9d83b01210c6695855eeaad31d</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>VA Actions migration from Q to R</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_d943fc9d83b01210c6695855eeaad31d</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:22:19</sys_updated_on>
        <tablename>sys_script_fix</tablename>
    </sys_metadata_link>
</record_update>
