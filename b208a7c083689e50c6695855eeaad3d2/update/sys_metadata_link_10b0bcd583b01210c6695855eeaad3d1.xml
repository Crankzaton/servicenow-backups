<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>19ada35a434131101487b5d31cb8f247</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;public&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;sn_cs_builder.VADesignerFacadeUtil&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Utilities to help when using facade nodes in VA&lt;/description&gt;
        &lt;name&gt;VADesignerFacadeUtil&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var VADesignerFacadeUtil = Class.create();
VADesignerFacadeUtil.prototype = {
    initialize: function() {
    },

    type: 'VADesignerFacadeUtil',

	_traverseAndReplaceConfig: function (vaInputs, node) {
		var self = this;
		// string
		if (typeof node === 'string') {
			var newValue = node;
			for (var index = 0; index &lt; vaInputs.length; index++) {
				newValue = newValue.replace('{{' + index + '}}', vaInputs[index]);
			}
			return newValue;
		}

		// array
		if (Array.isArray(node)) {
			node.forEach(function(item, index) {
				node[index] = self._traverseAndReplaceConfig(vaInputs, item);
			});
			return node;
		}

		// object
		if (typeof node === 'object') {
			Object.keys(node).forEach(function(key) {
				node[key] = self._traverseAndReplaceConfig(vaInputs, node[key]);
			});
			return node;
		}
		return node;
	},

	buildDefinitionConfig: function(vaInputs) {
		var definitions = JSON.parse(vaInputs.definition.getValue());
		var config = definitions.configuration;
		this._traverseAndReplaceConfig(vaInputs.inputs.getValue(), config);
		return config;
	},

	// Deprecated. 
	// Needed by customers that started using nowassist in VP4, without now-assist-va-designer store app
	buildPromptsHelper: function(vaInputs, type) {
		var definitions = JSON.parse(vaInputs.definition.getValue());
		var config = definitions.configuration;
		this._traverseAndReplaceConfig(vaInputs.inputs.getValue(), config);

		var promptConfig = {};

		switch (type) {
			case 'AITask':
				var isStructured = vaInputs.structured.getValue() === true;
				promptConfig = this.buildAIPrompt(config, isStructured);
			break;
			case 'DataCollector':
				promptConfig = this.buildDataCollector(config);
			break;
			default:
				break;
				
		}
		return promptConfig;
	},

	// Deprecated. 
	// Needed by customers that started using nowassist in VP4, without now-assist-va-designer store app
	buildAIPrompt: function (config, isStructured) {
		var user_message = config.user_message;
		var advanced_parameters = config.advanced_parameters;
		if (isStructured) {
			var identity = config.identity;
			var instructions = config.instructions;
			var skills = config.skills;
			var actions = config.actions;
			var examples = config.examples;

			if (gs.nil(examples)) {
				examples = '';
			}

			var actionsList = [];
			if (actions.length &gt; 0) {
				for (var actionIndex = 0; actionIndex &lt; actions.length; ++actionIndex) {
					var action = actions[actionIndex];
					var payload = {
						action: action.name,
						arguments: action.arguments.reduce(function(values, argument) {
							values[argument.name] = argument.value;
							return values;
						}, {})
					};
					payload = JSON.stringify(payload);

					var parsedAction = {
						index: actionIndex + 1,
						name: action.name,
						description: action.description + '\n',
						example: payload + '\n'
					};

					actionsList.push(parsedAction);
				}
			}

			/// Build Skills List
			var skillsList = [];
			if (skills.length &gt; 0) {
				for (var skillsIndex = 0; skillsIndex &lt; skills.length; ++skillsIndex) {
					var skill = skills[skillsIndex];
					var argumentList = skill.arguments.reduce(function(values, argument) {
						values[argument.name] = argument.value;
						return values;
					}, {});
					argumentList = JSON.stringify(argumentList);

					var parsedSkill = {
						index: skillsIndex + 1,
						id: skill.id,
						instructions: skill.instructions,
						arguments: argumentList
					};

					skillsList.push(parsedSkill);
				}
			}

			return {
				identity: identity,
				instructions: instructions,
				actions: actionsList,
				skills: skillsList,
				examples: examples,
				user_message: user_message,
				advanced_parameters: advanced_parameters
			};

		} else {
			return {
				system_prompt: config.system_prompt,
				user_message: user_message,
				advanced_parameters: advanced_parameters
			};
		}
	},

	// Deprecated. 
	// Needed by customers that started using nowassist in VP4, without now-assist-va-designer store app
	buildDataCollector: function (config) {
		var purpose = config.purpose;
		var inputs = this._migrateInputs(config.inputs);
		var instructions = config.instructions;
		var advanced_parameters = config.advanced_parameters;

		if (gs.nil(instructions)) {
			instructions = '';
		}

		/// Build Inputs List
		var inputList = '\n';
		for(var i = 0; i &lt; inputs.length; i++){
			inputList += JSON.stringify(this._filterInput(inputs[i])) + '\n\n';
		}

		return {
			purpose: purpose,
			inputs: inputList,
			inputsArray: inputs,
			instructions: instructions,
			advanced_parameters: advanced_parameters
		};
	},

	// Deprecated.
	// Needed by customers that started using nowassist in VP4, without now-assist-va-designer store app
	_migrateInputs: function(inputs) {
		var migrated = [];
		inputs.forEach(function(input) {
			if ((typeof input) === 'string') {
				var delimiter = ': ';
				var delimiterIndex = input.indexOf(delimiter);
				var fieldName = input.substr(0, delimiterIndex);
				var description = input.substr(delimiterIndex + delimiter.length);
				migrated.push({ name: fieldName, description: description, type: 'string' });
			} else {
				return migrated.push(input);
			}
		});
		return migrated;
	},

	// Deprecated. 
	// Needed by customers that started using nowassist in VP4, without now-assist-va-designer store app
	_filterInput: function(input) {
		var allowableProperties = [
			'name',
			'type',
			'description',
			'format',
			'choices'
		];
		var arrayUtil = new global.ArrayUtil();
		var filteredInput = {};
		Object.keys(input).forEach(function(name) {
			var value = input[name];
			if (arrayUtil.contains(allowableProperties, name)) {
				filteredInput[name] = value;
			}
		});
		if (input.type === 'reference') {
			filteredInput['notes'] = 'In addition to regular answers, there is a small chance the user may answer with an id/code.';
		}
		return filteredInput;
	}
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2023-09-05 18:25:10&lt;/sys_created_on&gt;
        &lt;sys_id&gt;19ada35a434131101487b5d31cb8f247&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;22&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;VADesignerFacadeUtil&lt;/sys_name&gt;
        &lt;sys_package display_value="Conversation Builder" source="sn_cs_builder"&gt;a6c104e2b3133200f7d1a13816a8dc64&lt;/sys_package&gt;
        &lt;sys_policy&gt;read&lt;/sys_policy&gt;
        &lt;sys_scope display_value="Conversation Builder"&gt;a6c104e2b3133200f7d1a13816a8dc64&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_19ada35a434131101487b5d31cb8f247&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2024-02-06 19:07:38&lt;/sys_updated_on&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-09-21 08:11:04</sys_created_on>
        <sys_id>10b0bcd583b01210c6695855eeaad3d1</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>VADesignerFacadeUtil</sys_name>
        <sys_package display_value="Now Utils" source="x_938076_now_utils">b208a7c083689e50c6695855eeaad3d2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Now Utils">b208a7c083689e50c6695855eeaad3d2</sys_scope>
        <sys_update_name>sys_metadata_link_10b0bcd583b01210c6695855eeaad3d1</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-09-21 08:11:04</sys_updated_on>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
